/*
  backgrid
  http://github.com/wyuenho/backgrid

  Copyright (c) 2012 Jimmy Yuen Ho Wong
  Licensed under the MIT @license.
*/
(function(e){var t=t||function(e){throw new ReferenceError(e+" is required but missing.")},i=e._||t("underscore"),n=e.Backbone||t("backbone");i.string||i.str||(i.string=i.str=t("underscore.string"));var r=e.Backgrid={},o=r.Formatter=function(){};i.extend(o.prototype,{fromRaw:function(e){return e},toRaw:function(e){return e}});var a=r.CellEditor=n.View.extend({tagName:"div",attributes:{contenteditable:"true"},events:{blur:"saveOrCancel",keydown:"saveOrCancel"},initialize:function(e){n.View.prototype.initialize.apply(this,arguments),this.formatter=e&&e.formatter||this.formatter,this.column=e&&e.column,this.on("done",this.remove,this)},render:function(){return this.$el.text(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this},postRender:function(){if(this.$el.focus(),window.getSelection!==void 0&&document.createRange!==void 0){var e=document.createRange();e.selectNodeContents(this.el),e.collapse(!1);var t=window.getSelection();t.removeAllRanges(),t.addRange(e)}if(document.body.createTextRange!==void 0){var i=document.body.createTextRange();i.moveToElementText(this.el),i.collapse(!1),i.select()}},saveOrCancel:function(e){if(e.type==="keydown")if(e.keyCode===13||e.keyCode===9){e.preventDefault();var t=this.formatter.toRaw(this.$el.text());this.model.set(this.column.get("name"),t)&&this.trigger("done")}else e.keyCode===27&&(e.stopPropagation(),this.$el.text(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this.trigger("done"));else e.type==="blur"&&(this.$el.text(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this.trigger("done"))},remove:function(){if(n.View.prototype.remove.apply(this,arguments),window.getSelection!==void 0){var e=window.getSelection();e.removeAllRanges()}}}),l=r.Cell=n.View.extend({tagName:"td",formatter:new o,editor:a,events:{click:"enterEditMode"},initialize:function(e){n.View.prototype.initialize.apply(this,arguments),this.formatter=e&&e.formatter||this.formatter,this.editor=e&&e.editor||this.editor,this.column=e&&e.column},render:function(){return this.$el.empty().text(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this},enterEditMode:function(){if(this.column.get("editable")){var e=new this.editor({column:this.column,model:this.model,formatter:this.formatter});e.on("done",this.exitEditMode,this),this.$el.empty(),this.undelegateEvents(),this.$el.append(e.render().$el),e.postRender(),this.$el.addClass("editor")}},exitEditMode:function(){this.$el.removeClass("editor"),this.render(),this.delegateEvents()}}),s=r.StringCell=l.extend({className:"string-cell",formatter:{fromRaw:function(e){return i.escape(e)},toRaw:function(e){return e}}});r.URICell=s.extend({className:"uri-cell",render:function(e){this.setElement(this.$el.clone(!0,!0)[0]),this.$el.empty();var t=this.formatter.fromRaw(e.get(this.column.get("name")));return this.$el.text(t).children().wrap("<a>",{href:t}),this}});var c=r.NumberCell=l.extend({className:"number-cell",decimals:2,decimalSeparator:".",orderSeparator:",",initialize:function(e){var t=this;l.prototype.initialize.apply(t,arguments),e&&(t.decimals=e.decimals!==void 0?e.decimals:t.decimals,t.decimalSeparator=e.decimalSeparator||t.decimalSeparator,t.orderSeparator=e.orderSeparator!==void 0?e.orderSeparator:t.orderSeparator),t.formatter=e&&e.formatter||{fromRaw:function(e){var n=i.str.numberFormat(e,t.decimals,t.decimalSeparator);return n.replace(",",t.orderSeparator)},toRaw:function(e){var n=i.str.trim(e).replace(t.orderSeparator,"").replace(t.decimalSeparator,".")*1||0;return n=n.toFixed(~~t.decimals)*1}}}});r.IntegerCell=c.extend({className:"integer-cell",decimals:0}),r.DatetimeCell=l.extend({className:"datetime-cell",formatter:{fromRaw:function(e){return new Date(e).toISOString()},toRaw:function(){return new Date(rawData).toISOString()}}});var d=r.Column=n.Model.extend({defaults:{name:null,label:null,sortable:!0,editable:!0,renderable:!0,formatter:null,cell:null},initialize:function(e){if(this.has("label")||this.set({label:this.get("name")},{silent:!0}),!e.cell)throw Error("Column.cell is required");if(!e.name)throw Error("Column.name is required");typeof e.cell=="string"?this.set({cell:r[i.str.capitalize(this.get("cell"))+"Cell"]},{silent:!0}):this.set({cell:e.cell},{silent:!0})}}),h=r.Columns=n.Collection.extend({model:d}),u=r.Row=n.View.extend({tagName:"tr",initialize:function(e){var t=this;t.parent=e.parent,t.columns=e.columns,t.columns instanceof n.Collection||(t.columns=new h(t.columns))},render:function(){var e=this;return e.$el.empty(),e.columns.each(function(t){if(t.get("renderable")){var i=t.get("cell");i=new i({column:t,model:e.model}),e.$el.append(i.render(e.model).$el)}}),e}}),m=r.HeaderCell=n.View.extend({tagName:"th",events:{"click a":"triggerSort"},direction:null,initialize:function(e){this.parent=e.parent,this.column=e.column,!this.column instanceof d&&(this.column=new d(this.column))},toggle:function(e,t){var i=this.$el.find("a");i.removeClass("ascending descending"),e===this.column.get("name")?(t&&i.addClass(t),this.direction=t):this.direction=null},triggerSort:function(e){e.preventDefault();var t=this,i=t.column.get("name");this.direction==="ascending"?t.trigger("sort",function(e,t){var n=e.get(i),r=t.get(i);return n===r?0:n>r?-1:1},i,"descending"):this.direction==="descending"?t.trigger("sort",null,i,null):t.trigger("sort",function(e,t){var n=e.get(i),r=t.get(i);return n===r?0:r>n?-1:1},i,"ascending")},render:function(){this.$el.empty();var e=$("<a>").text(this.column.get("label")).append("<b class='sort-caret'></b>");return this.$el.append(e),this}}),p=r.Header=n.View.extend({tagName:"thead",initialize:function(e){var t=this;t.parent=e.parent,t.columns=e.columns,t.columns instanceof n.Collection||(t.columns=new h(t.columns)),t.cells=[];for(var i=0;t.columns.length>i;i++){var r=t.columns.at(i);if(r.get("renderable")){var o=new m({parent:t,column:r});o.on("sort",t.dispatchSortEvent,t),t.cells.push(o)}}},dispatchSortEvent:function(e,t,n){this.parent.sort(e),i.each(this.cells,function(e){e.toggle(t,n)})},render:function(){var e=this;return e.$el.empty(),i.each(e.cells,function(t){e.$el.append(t.render().$el)}),e}}),g=r.Body=n.View.extend({tagName:"tbody",initialize:function(e){var t=this;t.parent=e.parent,t.columns=e.columns,t.columns instanceof n.Collection||(t.columns=new h(t.columns)),t.rows=t.collection.map(function(e){var i=new u({parent:t,columns:t.columns,model:e});return i}),t.collection.on("add",t.insertRow,t),t.collection.on("remove",t.removeRow,t),t.collection.on("reset",t.refresh,t),t.collection.comparator||(t.collection.comparator=t._idCidComparator)},sort:function(e){this.collection.comparator=e||this._idCidComparator,this.collection.sort()},_idCidComparator:function(e,t){var i=e.id,n=e.cid,r=t.cid,o=t.rcid;if(i&&r){if(r>i)return-1;if(i>r)return-1}else if(i&&o){if(o>i)return-1;if(i>o)return 1}else if(n&&r){if(r>n)return-1;if(n>r)return 1}else if(n&&o){if(o>n)return-1;if(n>o)return 1}return 0},insertRow:function(e,t,i){if(i){var n=new u({parent:this,columns:this.columns,model:e});this.rows.splice(i.index,0,n),(i.render===void 0||i.render)&&(i.index>=this.$el.children().length?this.$el.children().last().after(n.render().$el):this.$el.children().eq(i.index).before(n.render().$el))}else this.collection.add(e,i=t)},removeRow:function(e,t,i){i?((i.render===void 0||i.render)&&this.rows[i.index].remove(),this.rows.splice(i.index,1)):this.collection.remove(e,i=t)},refresh:function(){var e=this;return e.rows=e.collection.map(function(t){var i=new u({parent:e,columns:e.columns,model:t});return i}),e.render()},render:function(){var e=this;return e.$el.empty(),i.each(e.rows,function(t){e.$el.append(t.render().$el)}),this}}),f=r.Footer=n.View.extend({tagName:"tfoot"});r.Grid=n.View.extend({tagName:"table",className:"backgrid",initialize:function(e){this.columns=e.columns,this.header=e.header||p,this.header=new this.header({parent:this,columns:this.columns,collection:this.collection}),this.body=new g({parent:this,columns:this.columns,collection:this.collection}),e.footer&&(this.footer=new e.footer({parent:this,columns:this.columns,collection:this.collection}))},sort:function(e){this.body.sort(e)},render:function(){return this.$el.empty(),this.$el.append(this.header.render().$el),this.footer&&this.$el.append(this.footer.render().$el),this.$el.append(this.body.render().$el),this.trigger("rendered"),this}}),r.PageableCollection=n.Collection.extend({perPage:30,page:0,initialize:function(e,t){n.Collection.prototype.initialize.apply(this,arguments),t&&(this.perPage=t.perPage||this.perPage,this.page=t.page||this.page)},parse:function(e,t){var i=t.getResponseHeader("X-Object-Count");return i&&(this.pageCount=i*1/this.perPage),e},fetch:function(e){var t=this;e=e?i.clone(e):{};var r=e.success;return e.success=function(e){r&&r(t,e),t.trigger("fetched")},this.trigger("fetching"),n.Collection.prototype.fetch(e)},prevPage:function(){return this.getPage(this.page+1)},nextPage:function(){return this.getPage(this.page-1)},getPage:function(e){if(0>this.page)throw new RangeError("You are already at the first page.");if(this.page>=this.pageCount)throw new RangeError("You are already at the last page.");return this.page=e,this.fetch({data:{page:this.page,per_page:this.perPage}})}});var w=r.PaginatorItem=n.View.extend({tagName:"li",events:{"click a":"triggerLinkClicked"},initialize:function(e){this.label=e.label,this.page=e.page,this.hasAnchor=e.hasAnchor!==void 0?e.hasAnchor:!0},render:function(){if(this.hasAnchor){var e=$("<a>"+this.label+"</a>",{href:"#",title:"Page "+this.label});this.$el.append(e)}else this.$el.text(this.label);return this},triggerLinkClicked:function(e){e.preventDefault(),this.trigger("clicked",this.page)}});r.Paginator=f.extend({className:"paginator",windowSize:10,initialize:function(e){f.prototype.initialize.apply(this,arguments),this.collection.on("fetched",this.refresh,this),e=e?i.clone(e):{},this.windowSize=e.windowSize||this.windowSize},refresh:function(){var e=this.$el.find("ul"),t=this.collection;if(t.page>0){var i=new w({label:">",page:t.page});i.on("clicked",t.getPage,t),e.append(i.render().$el)}var n=Math.ceil(t.pageCount/t.pageSize)-1,r=t.page%this.windowSize+Math.floor(t.page/this.windowSize),o=r+this.windowSize;o=n>=o?o:n;for(var a=r;o>a;a++){var i=new w({label:a+1,page:a,hasAnchor:a!==t.page});i.on("clicked",t.getPage,t),e.append(i.render().$el)}if(t.pageCount-1>t.page){var i=new w({label:"<",page:t.page});i.on("clicked",t.getPage,t),e.append(i.render().$el)}},render:function(){var e=i.reduce(self.columns.pluck("renderable"),function(e,t){return t?e+1:0},0);return this.$el.append($("<tr><td span='"+e+"'><ul></ul></td></tr>")),this.refresh(),this}})})(this)