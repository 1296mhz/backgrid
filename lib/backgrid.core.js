/*
  backgrid
  http://github.com/wyuenho/backgrid

  Copyright (c) 2012 Jimmy Yuen Ho Wong
  Licensed under the MIT @license.
*/

(function (root) {

var require=require||function(packageName){throw new ReferenceError(packageName+" is required but missing.")};var _=root._||require("underscore");var Backbone=root.Backbone||require("backbone");function trim(s){if(String.prototype.trim){return String.prototype.trim.call(s,s)}return s.replace(/^\s+|\s+$/g,"")}function capitalize(s){return String.fromCharCode(s.charCodeAt(0)-32)+s.slice(1)}var Backgrid=root.Backgrid={};var Formatter=Backgrid.Formatter=function(){};_.extend(Formatter.prototype,{fromRaw:function(rawData){return rawData},toRaw:function(formattedData){return formattedData}});var NumberFormatter=Backgrid.NumberFormatter=function(options){options=options?_.clone(options):{};_.extend(this,this.defaults,options);if(this.decimals<0||this.decimals>20){throw new RangeError("decimals must be between 0 and 20")}};NumberFormatter.prototype=new Formatter;_.extend(NumberFormatter.prototype,{defaults:{decimals:2,decimalSeparator:".",orderSeparator:","},fromRaw:function(rawData){var numStr=rawData+"";var numDigitsBeforeDecimal=numStr.indexOf(".");var decimalPart="";if(numDigitsBeforeDecimal===-1){numDigitsBeforeDecimal=numStr.length}else{var head=numStr.slice(numDigitsBeforeDecimal+1,numDigitsBeforeDecimal+1+this.decimals);var tail=numStr[numDigitsBeforeDecimal+1+this.decimals];decimalPart=tail>4?head.slice(0,head.length-1)+(head[head.length-1]*1+1):head}var integerPart=numStr.slice(0,numDigitsBeforeDecimal);var formattedIntegerPart="";for(var i=integerPart.length-1;i>=0;i--){if((integerPart.length-i)%3===0){formattedIntegerPart=this.orderSeparator+integerPart.slice(i,i+3)+formattedIntegerPart}}formattedIntegerPart=formattedIntegerPart[0]===","?formattedIntegerPart.slice(1):formattedIntegerPart;var leftover=integerPart.slice(0,numDigitsBeforeDecimal%3);if(leftover&&formattedIntegerPart){formattedIntegerPart=leftover+","+formattedIntegerPart}else if(!formattedIntegerPart){formattedIntegerPart=leftover}else if(!leftover&&!formattedIntegerPart){formattedIntegerPart=integerPart}return decimalPart?formattedIntegerPart+this.decimalSeparator+decimalPart:formattedIntegerPart},toRaw:function(formattedData){var rawData="";var thousands=trim(formattedData).split(this.orderSeparator);for(var i=0;i<thousands.length;i++){rawData+=thousands[i]}var decimalParts=rawData.split(this.decimalSeparator);rawData="";for(var i=0;i<decimalParts.length;i++){rawData=rawData+decimalParts[i]+"."}if(rawData[rawData.length-1]==="."){rawData=rawData.slice(0,rawData.length-1)}return(rawData*1).toFixed(~~this.decimals)*1}});var DatetimeFormatter=Backgrid.DatetimeFormatter=function(options){options=options?_.clone(options):{};_.extend(this,this.defaults,options);if(!this.includeDate&&!this.includeTime)throw new Error("Either includeDate or includeTime must be true")};DatetimeFormatter.prototype=new Formatter;_.extend(DatetimeFormatter.prototype,{defaults:{includeDate:true,includeTime:true},fromRaw:function(rawData){var formattedData=new Date(rawData).toISOString();if(!this.includeTime){return formattedData.slice(0,formattedData.indexOf("T"))}return formattedData.slice(formattedData.indexOf("T")+1)},toRaw:function(formattedData){if(!this.includeTime){var tIndex=formattedData.indexOf("T");if(tIndex!==-1){formattedData=formattedData.slice(0,tIndex)}return new Date(formattedData).toISOString()}var hms=formattedData.split(":");var ms=0;if(hms[3]){ms=hms[3].slice(hms[3].indexOf(".")+1);hms[3].replace("."+ms,"")}return new Date(null,null,null,hms[0],hms[1],hms[2],ms)}});var DivCellEditor=Backgrid.CellEditor=Backbone.View.extend({tagName:"div",attributes:{contenteditable:"true"},events:{blur:"saveOrCancel",keydown:"saveOrCancel"},initialize:function(options){Backbone.View.prototype.initialize.apply(this,arguments);this.formatter=options&&options.formatter||this.formatter;this.column=options&&options.column;this.on("done",this.remove,this)},render:function(){this.$el.text(this.formatter.fromRaw(this.model.get(this.column.get("name"))));return this},postRender:function(){this.$el.focus();if(typeof window.getSelection!=="undefined"&&typeof document.createRange!=="undefined"){var rng=document.createRange();rng.selectNodeContents(this.el);rng.collapse(false);var sel=window.getSelection();sel.removeAllRanges();sel.addRange(rng)}if(typeof document.body.createTextRange!=="undefined"){var txtRng=document.body.createTextRange();txtRng.moveToElementText(this.el);txtRng.collapse(false);txtRng.select()}},saveOrCancel:function(e){if(e.type==="keydown"){if(e.keyCode===13||e.keyCode===9){e.preventDefault();var valueToSet=this.formatter.toRaw(this.$el.text());if(this.model.set(this.column.get("name"),valueToSet)){this.trigger("done")}else{}}else if(e.keyCode===27){e.stopPropagation();this.$el.text(this.formatter.fromRaw(this.model.get(this.column.get("name"))));this.trigger("done")}}else if(e.type==="blur"){this.$el.text(this.formatter.fromRaw(this.model.get(this.column.get("name"))));this.trigger("done")}},remove:function(){Backbone.View.prototype.remove.apply(this,arguments);if(typeof window.getSelection!=="undefined"){var sel=window.getSelection();sel.removeAllRanges()}}});var Cell=Backgrid.Cell=Backbone.View.extend({tagName:"td",formatter:new Formatter,editor:DivCellEditor,events:{click:"enterEditMode"},initialize:function(options){Backbone.View.prototype.initialize.apply(this,arguments);this.formatter=options&&options.formatter||this.formatter;this.editor=options&&options.editor||this.editor;this.column=options&&options.column},render:function(){this.$el.empty().text(this.formatter.fromRaw(this.model.get(this.column.get("name"))));return this},enterEditMode:function(e){if(this.column.get("editable")){var editor=new this.editor({column:this.column,model:this.model,formatter:this.formatter});editor.on("done",this.exitEditMode,this);this.$el.empty();this.undelegateEvents();this.$el.append(editor.render().$el);editor.postRender();this.$el.addClass("editor")}},exitEditMode:function(){this.$el.removeClass("editor");this.render();this.delegateEvents()}});var StringCell=Backgrid.StringCell=Cell.extend({className:"string-cell",formatter:{fromRaw:function(rawData){return _.escape(rawData)},toRaw:function(formattedData){return formattedData}}});var UriCell=Backgrid.UriCell=StringCell.extend({className:"uri-cell",formatter:{fromRaw:function(rawData){return rawData},toRaw:function(formattedData){return encodeURI(formattedData)}},render:function(){this.$el.empty();var formattedValue=this.formatter.fromRaw(this.model.get(this.column.get("name")));this.$el.append($("<a>",{href:formattedValue,title:formattedValue}).text(formattedValue));return this}});var NumberCell=Backgrid.NumberCell=Cell.extend({className:"number-cell",decimals:NumberFormatter.prototype.defaults.decimals,decimalSeparator:NumberFormatter.prototype.defaults.decimalSeparator,orderSeparator:NumberFormatter.prototype.defaults.orderSeparator,initialize:function(options){Cell.prototype.initialize.apply(this,arguments);if(options){this.decimals=typeof options.decimals!=="undefined"?options.decimals:this.decimals;this.decimalSeparator=typeof options.decimalSeparator!=="undefined"?options.decimalSeparator:this.decimalSeparator;this.orderSeparator=typeof options.orderSeparator!=="undefined"?options.orderSeparator:this.orderSeparator}this.formatter=options&&options.formatter||new NumberFormatter({decimals:this.decimals,decimalSeparator:this.decimalSeparator,orderSeparator:this.orderSeparator})}});var IntegerCell=Backgrid.IntegerCell=NumberCell.extend({className:"integer-cell",decimals:0});var DatetimeCell=Backgrid.DatetimeCell=Cell.extend({className:"datetime-cell",includeDate:DatetimeFormatter.prototype.defaults.includeDate,includeTime:DatetimeFormatter.prototype.defaults.includeTime,initialize:function(options){Cell.prototype.initialize.apply(this,arguments);if(options){this.includeDate=typeof options.includeDate!=="undefined"?options.includeDate:this.includeDate;this.includeTime=typeof options.includeTime!=="undefined"?options.includeTime:this.includeTime}this.formatter=options&&options.formatter||new DatetimeFormatter({includeDate:this.includeDate,includeTime:this.includeTime})}});var DateCell=Backgrid.DateCell=DatetimeCell.extend({className:"date-cell",includeTime:false});var TimeCell=Backgrid.TimeCell=DatetimeCell.extend({className:"date-cell",includeDate:false});var Column=Backgrid.Column=Backbone.Model.extend({defaults:{name:null,label:null,sortable:true,editable:true,renderable:true,formatter:null,cell:null},initialize:function(attrs){if(!this.has("label")){this.set({label:this.get("name")},{silent:true})}if(!attrs.cell){throw new Error("Column.cell is required")}if(!attrs.name){throw new Error("Column.name is required")}if(typeof attrs.cell==="string"){var cell=Backgrid[capitalize(this.get("cell"))+"Cell"];if(typeof cell==="undefined")throw new ReferenceError("Cell type '"+attrs.cell+"' not found");this.set({cell:cell},{silent:true})}else{this.set({cell:attrs.cell},{silent:true})}}});var Columns=Backgrid.Columns=Backbone.Collection.extend({model:Column});var Row=Backgrid.Row=Backbone.View.extend({tagName:"tr",initialize:function(options){var self=this;self.parent=options.parent;self.columns=options.columns;if(!(self.columns instanceof Backbone.Collection)){self.columns=new Columns(self.columns)}},render:function(){var self=this;self.$el.empty();self.columns.each(function(column){if(column.get("renderable")){var cell=column.get("cell");cell=new cell({column:column,model:self.model});self.$el.append(cell.render(self.model).$el)}});return self}});var HeaderCell=Backgrid.HeaderCell=Backbone.View.extend({tagName:"th",events:{"click a":"triggerSort"},direction:null,initialize:function(options){this.parent=options.parent;this.column=options.column;if(!this.column instanceof Column){this.column=new Column(this.column)}},toggle:function(columnName,direction){var $label=this.$el.find("a");$label.removeClass("ascending descending");if(columnName===this.column.get("name")){if(direction){$label.addClass(direction)}this.direction=direction}else{this.direction=null}},triggerSort:function(e){e.preventDefault();var self=this;var columnName=self.column.get("name");if(this.direction==="ascending"){self.trigger("sort",function(left,right){var leftVal=left.get(columnName);var rightVal=right.get(columnName);if(leftVal===rightVal){return 0}else if(leftVal>rightVal){return-1}return 1},columnName,"descending")}else if(this.direction==="descending"){self.trigger("sort",null,columnName,null)}else{self.trigger("sort",function(left,right){var leftVal=left.get(columnName);var rightVal=right.get(columnName);if(leftVal===rightVal){return 0}else if(leftVal<rightVal){return-1}return 1},columnName,"ascending")}},render:function(){this.$el.empty();var $label=$("<a>").text(this.column.get("label")).append("<b class='sort-caret'></b>");this.$el.append($label);return this}});var Header=Backgrid.Header=Backbone.View.extend({tagName:"thead",initialize:function(options){var self=this;self.parent=options.parent;self.columns=options.columns;if(!(self.columns instanceof Backbone.Collection)){self.columns=new Columns(self.columns)}self.cells=[];for(var i=0;i<self.columns.length;i++){var column=self.columns.at(i);if(column.get("renderable")){var cell=new HeaderCell({parent:self,column:column});cell.on("sort",self.dispatchSortEvent,self);self.cells.push(cell)}}},dispatchSortEvent:function(comparator,sortByColName,direction){this.parent.sort(comparator);_.each(this.cells,function(cell){cell.toggle(sortByColName,direction)})},render:function(){var self=this;self.$el.empty();_.each(self.cells,function(cell){self.$el.append(cell.render().$el)});return self}});var Body=Backgrid.Body=Backbone.View.extend({tagName:"tbody",initialize:function(options){var self=this;self.parent=options.parent;self.columns=options.columns;if(!(self.columns instanceof Backbone.Collection)){self.columns=new Columns(self.columns)}self.rows=self.collection.map(function(model){var row=new Row({parent:self,columns:self.columns,model:model});return row});self.collection.on("add",self.insertRow,self);self.collection.on("remove",self.removeRow,self);self.collection.on("reset",self.refresh,self);if(!self.collection.comparator){self.collection.comparator=self._idCidComparator}},sort:function(comparator){this.collection.comparator=comparator||this._idCidComparator;this.collection.sort()},_idCidComparator:function(left,right){var lid=left.id,lcid=left.cid,rid=right.cid,rcid=right.rcid;if(lid&&rid){if(lid<rid)return-1;else if(lid>rid)return-1}else if(lid&&rcid){if(lid<rcid)return-1;else if(lid>rcid)return 1}else if(lcid&&rid){if(lcid<rid)return-1;else if(lcid>rid)return 1}else if(lcid&&rcid){if(lcid<rcid)return-1;else if(lcid>rcid)return 1}return 0},insertRow:function(model,collection,options){if(!options){this.collection.add(model,options=collection);return}var row=new Row({parent:this,columns:this.columns,model:model});this.rows.splice(options.index,0,row);if(typeof options.render==="undefined"||options.render){if(options.index>=this.$el.children().length){this.$el.children().last().after(row.render().$el)}else{this.$el.children().eq(options.index).before(row.render().$el)}}},removeRow:function(model,collection,options){if(!options){this.collection.remove(model,options=collection);return}if(typeof options.render==="undefined"||options.render){this.rows[options.index].remove()}this.rows.splice(options.index,1)},refresh:function(){var self=this;self.rows=self.collection.map(function(model){var row=new Row({parent:self,columns:self.columns,model:model});return row});return self.render()},render:function(){var self=this;self.$el.empty();_.each(self.rows,function(row){self.$el.append(row.render().$el)});return this}});var Footer=Backgrid.Footer=Backbone.View.extend({tagName:"tfoot"});var Grid=Backgrid.Grid=Backbone.View.extend({tagName:"table",className:"backgrid",initialize:function(options){this.columns=options.columns;this.header=options.header||Header;this.header=new this.header({parent:this,columns:this.columns,collection:this.collection});this.body=new Body({parent:this,columns:this.columns,collection:this.collection});if(options.footer){this.footer=new options.footer({parent:this,columns:this.columns,collection:this.collection})}},sort:function(comparator){this.body.sort(comparator)},render:function(){this.$el.empty();this.$el.append(this.header.render().$el);if(this.footer){this.$el.append(this.footer.render().$el)}this.$el.append(this.body.render().$el);this.trigger("rendered");return this}})}(this));
