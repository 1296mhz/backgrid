/*
  backgrid
  http://github.com/wyuenho/backgrid

  Copyright (c) 2012 Jimmy Yuen Ho Wong
  Licensed under the MIT @license.
*/
(function(e){function t(e){return String.prototype.trim?String.prototype.trim.call(e,e):e.replace(/^\s+|\s+$/g,"")}function i(e){return String.fromCharCode(e.charCodeAt(0)-32)+e.slice(1)}var n=n||function(e){throw new ReferenceError(e+" is required but missing.")},r=e._||n("underscore"),o=e.Backbone||n("backbone"),l=e.Backgrid={},a=l.Formatter=function(){};r.extend(a.prototype,{fromRaw:function(e){return e},toRaw:function(e){return e}});var s=l.NumberFormatter=function(e){if(e=e?r.clone(e):{},r.extend(this,this.defaults,e),0>this.decimals||this.decimals>20)throw new RangeError("decimals must be between 0 and 20")};s.prototype=new a,r.extend(s.prototype,{defaults:{decimals:2,decimalSeparator:".",orderSeparator:","},fromRaw:function(e){var t=e+"",i=t.indexOf("."),n="";if(i===-1)i=t.length;else{var r=t.slice(i+1,i+1+this.decimals),o=t[i+1+this.decimals];n=o>4?r.slice(0,r.length-1)+(r[r.length-1]*1+1):r}for(var l=t.slice(0,i),a="",s=l.length-1;s>=0;s--)(l.length-s)%3===0&&(a=this.orderSeparator+l.slice(s,s+3)+a);a=a[0]===","?a.slice(1):a;var c=l.slice(0,i%3);return c&&a?a=c+","+a:a?c||a||(a=l):a=c,n?a+this.decimalSeparator+n:a},toRaw:function(e){for(var i="",n=t(e).split(this.orderSeparator),r=0;n.length>r;r++)i+=n[r];var o=i.split(this.decimalSeparator);i="";for(var r=0;o.length>r;r++)i=i+o[r]+".";return i[i.length-1]==="."&&(i=i.slice(0,i.length-1)),(i*1).toFixed(~~this.decimals)*1}});var c=l.DatetimeFormatter=function(e){if(e=e?r.clone(e):{},r.extend(this,this.defaults,e),!this.includeDate&&!this.includeTime)throw Error("Either includeDate or includeTime must be true")};c.prototype=new a,r.extend(c.prototype,{defaults:{includeDate:!0,includeTime:!0},fromRaw:function(e){var t=new Date(e).toISOString();return this.includeTime?t.slice(t.indexOf("T")+1):t.slice(0,t.indexOf("T"))},toRaw:function(e){if(!this.includeTime){var t=e.indexOf("T");return t!==-1&&(e=e.slice(0,t)),new Date(e).toISOString()}var i=e.split(":"),n=0;return i[3]&&(n=i[3].slice(i[3].indexOf(".")+1),i[3].replace("."+n,"")),new Date(null,null,null,i[0],i[1],i[2],n)}});var d=l.CellEditor=o.View.extend({tagName:"div",attributes:{contenteditable:"true"},events:{blur:"saveOrCancel",keydown:"saveOrCancel"},initialize:function(e){o.View.prototype.initialize.apply(this,arguments),this.formatter=e&&e.formatter||this.formatter,this.column=e&&e.column,this.on("done",this.remove,this)},render:function(){return this.$el.text(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this},postRender:function(){if(this.$el.focus(),window.getSelection!==void 0&&document.createRange!==void 0){var e=document.createRange();e.selectNodeContents(this.el),e.collapse(!1);var t=window.getSelection();t.removeAllRanges(),t.addRange(e)}if(document.body.createTextRange!==void 0){var i=document.body.createTextRange();i.moveToElementText(this.el),i.collapse(!1),i.select()}},saveOrCancel:function(e){if(e.type==="keydown")if(e.keyCode===13||e.keyCode===9){e.preventDefault();var t=this.formatter.toRaw(this.$el.text());this.model.set(this.column.get("name"),t)&&this.trigger("done")}else e.keyCode===27&&(e.stopPropagation(),this.$el.text(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this.trigger("done"));else e.type==="blur"&&(this.$el.text(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this.trigger("done"))},remove:function(){if(o.View.prototype.remove.apply(this,arguments),window.getSelection!==void 0){var e=window.getSelection();e.removeAllRanges()}}}),u=l.Cell=o.View.extend({tagName:"td",formatter:new a,editor:d,events:{click:"enterEditMode"},initialize:function(e){o.View.prototype.initialize.apply(this,arguments),this.formatter=e&&e.formatter||this.formatter,this.editor=e&&e.editor||this.editor,this.column=e&&e.column},render:function(){return this.$el.empty().text(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this},enterEditMode:function(){if(this.column.get("editable")){var e=new this.editor({column:this.column,model:this.model,formatter:this.formatter});e.on("done",this.exitEditMode,this),this.$el.empty(),this.undelegateEvents(),this.$el.append(e.render().$el),e.postRender(),this.$el.addClass("editor")}},exitEditMode:function(){this.$el.removeClass("editor"),this.render(),this.delegateEvents()}}),m=l.StringCell=u.extend({className:"string-cell",formatter:{fromRaw:function(e){return r.escape(e)},toRaw:function(e){return e}}});l.UriCell=m.extend({className:"uri-cell",formatter:{fromRaw:function(e){return e},toRaw:function(e){return encodeURI(e)}},render:function(){this.$el.empty();var e=this.formatter.fromRaw(this.model.get(this.column.get("name")));return this.$el.append($("<a>",{href:e,title:e}).text(e)),this}});var h=l.NumberCell=u.extend({className:"number-cell",decimals:s.prototype.defaults.decimals,decimalSeparator:s.prototype.defaults.decimalSeparator,orderSeparator:s.prototype.defaults.orderSeparator,initialize:function(e){u.prototype.initialize.apply(this,arguments),e&&(this.decimals=e.decimals!==void 0?e.decimals:this.decimals,this.decimalSeparator=e.decimalSeparator!==void 0?e.decimalSeparator:this.decimalSeparator,this.orderSeparator=e.orderSeparator!==void 0?e.orderSeparator:this.orderSeparator),this.formatter=e&&e.formatter||new s({decimals:this.decimals,decimalSeparator:this.decimalSeparator,orderSeparator:this.orderSeparator})}});l.IntegerCell=h.extend({className:"integer-cell",decimals:0});var f=l.DatetimeCell=u.extend({className:"datetime-cell",includeDate:c.prototype.defaults.includeDate,includeTime:c.prototype.defaults.includeTime,initialize:function(e){u.prototype.initialize.apply(this,arguments),e&&(this.includeDate=e.includeDate!==void 0?e.includeDate:this.includeDate,this.includeTime=e.includeTime!==void 0?e.includeTime:this.includeTime),this.formatter=e&&e.formatter||new c({includeDate:this.includeDate,includeTime:this.includeTime})}});l.DateCell=f.extend({className:"date-cell",includeTime:!1}),l.TimeCell=f.extend({className:"date-cell",includeDate:!1});var p=l.Column=o.Model.extend({defaults:{name:null,label:null,sortable:!0,editable:!0,renderable:!0,formatter:null,cell:null},initialize:function(e){if(this.has("label")||this.set({label:this.get("name")},{silent:!0}),!e.cell)throw Error("Column.cell is required");if(!e.name)throw Error("Column.name is required");if(typeof e.cell=="string"){var t=l[i(this.get("cell"))+"Cell"];if(t===void 0)throw new ReferenceError("Cell type '"+e.cell+"' not found");this.set({cell:t},{silent:!0})}else this.set({cell:e.cell},{silent:!0})}}),g=l.Columns=o.Collection.extend({model:p}),v=l.Row=o.View.extend({tagName:"tr",initialize:function(e){var t=this;t.parent=e.parent,t.columns=e.columns,t.columns instanceof o.Collection||(t.columns=new g(t.columns))},render:function(){var e=this;return e.$el.empty(),e.columns.each(function(t){if(t.get("renderable")){var i=t.get("cell");i=new i({column:t,model:e.model}),e.$el.append(i.render(e.model).$el)}}),e}}),w=l.HeaderCell=o.View.extend({tagName:"th",events:{"click a":"triggerSort"},direction:null,initialize:function(e){this.parent=e.parent,this.column=e.column,!this.column instanceof p&&(this.column=new p(this.column))},toggle:function(e,t){var i=this.$el.find("a");i.removeClass("ascending descending"),e===this.column.get("name")?(t&&i.addClass(t),this.direction=t):this.direction=null},triggerSort:function(e){e.preventDefault();var t=this,i=t.column.get("name");this.direction==="ascending"?t.trigger("sort",function(e,t){var n=e.get(i),r=t.get(i);return n===r?0:n>r?-1:1},i,"descending"):this.direction==="descending"?t.trigger("sort",null,i,null):t.trigger("sort",function(e,t){var n=e.get(i),r=t.get(i);return n===r?0:r>n?-1:1},i,"ascending")},render:function(){this.$el.empty();var e=$("<a>").text(this.column.get("label")).append("<b class='sort-caret'></b>");return this.$el.append(e),this}}),y=l.Header=o.View.extend({tagName:"thead",initialize:function(e){var t=this;t.parent=e.parent,t.columns=e.columns,t.columns instanceof o.Collection||(t.columns=new g(t.columns)),t.cells=[];for(var i=0;t.columns.length>i;i++){var n=t.columns.at(i);if(n.get("renderable")){var r=new w({parent:t,column:n});r.on("sort",t.dispatchSortEvent,t),t.cells.push(r)}}},dispatchSortEvent:function(e,t,i){this.parent.sort(e),r.each(this.cells,function(e){e.toggle(t,i)})},render:function(){var e=this;return e.$el.empty(),r.each(e.cells,function(t){e.$el.append(t.render().$el)}),e}}),x=l.Body=o.View.extend({tagName:"tbody",initialize:function(e){var t=this;t.parent=e.parent,t.columns=e.columns,t.columns instanceof o.Collection||(t.columns=new g(t.columns)),t.rows=t.collection.map(function(e){var i=new v({parent:t,columns:t.columns,model:e});return i}),t.collection.on("add",t.insertRow,t),t.collection.on("remove",t.removeRow,t),t.collection.on("reset",t.refresh,t),t.collection.comparator||(t.collection.comparator=t._idCidComparator)},sort:function(e){this.collection.comparator=e||this._idCidComparator,this.collection.sort()},_idCidComparator:function(e,t){var i=e.id,n=e.cid,r=t.cid,o=t.rcid;if(i&&r){if(r>i)return-1;if(i>r)return-1}else if(i&&o){if(o>i)return-1;if(i>o)return 1}else if(n&&r){if(r>n)return-1;if(n>r)return 1}else if(n&&o){if(o>n)return-1;if(n>o)return 1}return 0},insertRow:function(e,t,i){if(!i)return this.collection.add(e,i=t),void 0;var n=new v({parent:this,columns:this.columns,model:e});this.rows.splice(i.index,0,n),(i.render===void 0||i.render)&&(i.index>=this.$el.children().length?this.$el.children().last().after(n.render().$el):this.$el.children().eq(i.index).before(n.render().$el))},removeRow:function(e,t,i){return i?((i.render===void 0||i.render)&&this.rows[i.index].remove(),this.rows.splice(i.index,1),void 0):(this.collection.remove(e,i=t),void 0)},refresh:function(){var e=this;return e.rows=e.collection.map(function(t){var i=new v({parent:e,columns:e.columns,model:t});return i}),e.render()},render:function(){var e=this;return e.$el.empty(),r.each(e.rows,function(t){e.$el.append(t.render().$el)}),this}});l.Footer=o.View.extend({tagName:"tfoot"}),l.Grid=o.View.extend({tagName:"table",className:"backgrid",initialize:function(e){this.columns=e.columns,this.header=e.header||y,this.header=new this.header({parent:this,columns:this.columns,collection:this.collection}),this.body=new x({parent:this,columns:this.columns,collection:this.collection}),e.footer&&(this.footer=new e.footer({parent:this,columns:this.columns,collection:this.collection}))},sort:function(e){this.body.sort(e)},render:function(){return this.$el.empty(),this.$el.append(this.header.render().$el),this.footer&&this.$el.append(this.footer.render().$el),this.$el.append(this.body.render().$el),this.trigger("rendered"),this}})})(this)