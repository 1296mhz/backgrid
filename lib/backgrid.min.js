/*
  backgrid
  http://github.com/wyuenho/backgrid

  Copyright (c) 2012 Jimmy Yuen Ho Wong
  Licensed under the MIT @license.
*/
(function(e,t,i,n){function r(e){return String.prototype.trim?String.prototype.trim.call(e,e):e.replace(/^\s+|\s+$/g,"")}function o(e){return String.fromCharCode(e.charCodeAt(0)-32)+e.slice(1)}function s(e,t,i){var n=t-(e+"").length;n=0>n?0:n;for(var r="",o=0;n>o;o++)r+=i;return r+e}function l(e,t){for(var n=0;t.length>n;n++){var r=t[n];if(i.isUndefined(e[r]))throw new TypeError("'"+r+"' is required")}}function a(e,t){if(i.isString(e)){var n=o(e)+t,r=u[n]||u.Extension[n];if(i.isUndefined(r))throw new ReferenceError("Class '"+n+"' not found");return r}return e}var h=e,u=e.Backgrid={VERSION:"0.1",Extension:{}};n.View.prototype.dispose||i.extend(n.View.prototype,{dispose:function(){return this.undelegateEvents(),this.model&&this.model.off&&this.model.off(null,null,this),this.collection&&this.collection.off&&this.collection.off(null,null,this),this},remove:function(){return this.dispose(),this.$el.remove(),this}});var c=u.CellFormatter=function(){};i.extend(c.prototype,{fromRaw:function(e){return e},toRaw:function(e){return e}});var d=u.NumberFormatter=function(e){if(e=e?i.clone(e):{},i.extend(this,this.defaults,e),0>this.decimals||this.decimals>20)throw new RangeError("decimals must be between 0 and 20")};d.prototype=new c,i.extend(d.prototype,{defaults:{decimals:2,decimalSeparator:".",orderSeparator:","},HUMANIZED_NUM_RE:/(\d)(?=(?:\d{3})+$)/g,fromRaw:function(e){if(isNaN(e)||null===e)return"";e=e.toFixed(~~this.decimals);var t=e.split("."),i=t[0],n=t[1]?(this.decimalSeparator||".")+t[1]:"";return i.replace(this.HUMANIZED_NUM_RE,"$1"+this.orderSeparator)+n},toRaw:function(e){for(var t="",n=r(e).split(this.orderSeparator),o=0;n.length>o;o++)t+=n[o];var s=t.split(this.decimalSeparator);t="";for(var o=0;s.length>o;o++)t=t+s[o]+".";"."===t[t.length-1]&&(t=t.slice(0,t.length-1));var l=1*(1*t).toFixed(~~this.decimals);return i.isNumber(l)&&!i.isNaN(l)?l:void 0}});var m=u.DatetimeFormatter=function(e){if(e=e?i.clone(e):{},i.extend(this,this.defaults,e),!this.includeDate&&!this.includeTime)throw Error("Either includeDate or includeTime must be true")};m.prototype=new c,i.extend(m.prototype,{defaults:{includeDate:!0,includeTime:!0,includeMilli:!1},DATE_RE:/^([+\-]?\d{4})-(\d{2})-(\d{2})$/,TIME_RE:/^(\d{2}):(\d{2}):(\d{2})(\.(\d{3}))?$/,ISO_SPLITTER_RE:/T|Z| +/,_convert:function(e,t){e=r(e);var n=e.split(this.ISO_SPLITTER_RE)||[],o=this.DATE_RE.test(n[0])?n[0]:"",l=o&&n[1]?n[1]:this.TIME_RE.test(n[0])?n[0]:"",a=this.DATE_RE.exec(o)||[],h=this.TIME_RE.exec(l)||[];if(t){if(this.includeDate&&i.isUndefined(a[0]))return;if(this.includeTime&&i.isUndefined(h[0]))return;if(!this.includeDate&&o)return;if(!this.includeTime&&l)return}var u=new Date(Date.UTC(1*a[1]||0,1*a[2]-1||0,1*a[3]||0,1*h[1]||null,1*h[2]||null,1*h[3]||null,1*h[5]||null)),c="";return this.includeDate&&(c=s(u.getUTCFullYear(),4,0)+"-"+s(u.getUTCMonth()+1,2,0)+"-"+s(u.getUTCDate(),2,0)),this.includeTime&&(c=c+(this.includeDate?"T":"")+s(u.getUTCHours(),2,0)+":"+s(u.getUTCMinutes(),2,0)+":"+s(u.getUTCSeconds(),2,0),this.includeMilli&&(c=c+"."+s(u.getUTCMilliseconds(),3,0))),this.includeDate&&this.includeTime&&(c+="Z"),c},fromRaw:function(e){return this._convert(e)},toRaw:function(e){return this._convert(e,!0)}});var f=u.CellEditor=n.View.extend({initialize:function(e){l(e,["formatter","column","model"]),this.parent=e.parent,this.formatter=e.formatter,this.column=e.column,this.column instanceof E||(this.column=new E(this.column)),this.parent&&this.parent.on&&this.parent.on("editing",this.postRender,this)},dispose:function(){return this.column.off(null,null,this),this.parent&&this.parent.off&&this.parent.off(null,null,this),n.View.prototype.dispose.apply(this,arguments)},postRender:function(){return this.$el.focus(),this}}),p=u.InputCellEditor=f.extend({tagName:"input",attributes:{type:"text"},events:{blur:"saveOrCancel",keydown:"saveOrCancel"},initialize:function(e){f.prototype.initialize.apply(this,arguments),e.placeholder&&this.$el.attr("placeholder",e.placeholder),this.on("done",this.remove,this)},render:function(){return this.$el.val(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this},saveOrCancel:function(e){if("keydown"===e.type)if(13===e.keyCode||9===e.keyCode){e.preventDefault();var t=this.formatter.toRaw(this.$el.val());i.isUndefined(t)||!this.model.set(this.column.get("name"),t)?this.trigger("error"):this.trigger("done")}else 27===e.keyCode&&(e.stopPropagation(),this.trigger("done"));else if("blur"===e.type)if(this.formatter.fromRaw(this.model.get(this.column.get("name")))===this.$el.val())this.trigger("done");else var n=this,r=h.setTimeout(function(){n.$el.focus(),h.clearTimeout(r)},1)},postRender:function(){if("right"===this.$el.css("text-align")){var e=this.$el.val();this.$el.focus().val(null).val(e)}else this.$el.focus();return this}}),g=u.Cell=n.View.extend({tagName:"td",formatter:new c,editor:p,events:{click:"enterEditMode"},initialize:function(e){l(e,["model","column"]),this.parent=e.parent,this.column=e.column,this.column instanceof E||(this.column=new E(this.column)),this.formatter=a(this.formatter,"Formatter"),this.editor=a(this.editor,"CellEditor")},dispose:function(){return this.currentEditor&&this.exitEditMode(),this.column.off(null,null,this),this.parent&&this.parent.off&&this.parent.off(null,null,this),n.View.prototype.dispose.apply(this,arguments)},render:function(){return this.$el.empty().text(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this},enterEditMode:function(){this.column.get("editable")&&(this.currentEditor=new this.editor({parent:this,column:this.column,model:this.model,formatter:this.formatter}),this.trigger("edit",this,this.currentEditor),this.currentEditor.on("done",this.exitEditMode,this),this.currentEditor.on("error",this.renderError,this),this.$el.empty(),this.undelegateEvents(),this.$el.append(this.currentEditor.$el),this.currentEditor.render(),this.$el.addClass("editor"),this.trigger("editing",this,this.currentEditor))},renderError:function(){this.$el.addClass("error")},exitEditMode:function(){this.$el.removeClass("error"),this.currentEditor.off(null,null,this),this.currentEditor.remove(),delete this.currentEditor,this.$el.removeClass("editor"),this.render(),this.delegateEvents()},remove:function(){n.View.prototype.remove.apply(this,arguments),this.currentEditor&&(this.currentEditor.remove(),delete this.currentEditor)}});u.StringCell=g.extend({className:"string-cell"}),u.UriCell=g.extend({className:"uri-cell",formatter:{fromRaw:function(e){return e},toRaw:function(e){var t=encodeURI(e);return"undefined"===t?void 0:t}},render:function(){this.$el.empty();var e=this.formatter.fromRaw(this.model.get(this.column.get("name")));return this.$el.append(t("<a>",{href:e,title:e,target:"_blank"}).text(e)),this}}),u.EmailCell=g.extend({className:"email-cell",formatter:{fromRaw:function(e){return e},toRaw:function(e){var t=e.split("@");return 2===t.length&&i.all(t)?e:void 0}},render:function(){this.$el.empty();var e=this.formatter.fromRaw(this.model.get(this.column.get("name")));return this.$el.append(t("<a>",{href:"mailto:"+e,title:e}).text(e)),this}});var v=u.NumberCell=g.extend({className:"number-cell",decimals:d.prototype.defaults.decimals,decimalSeparator:d.prototype.defaults.decimalSeparator,orderSeparator:d.prototype.defaults.orderSeparator,formatter:d,initialize:function(){g.prototype.initialize.apply(this,arguments),this.formatter=new this.formatter({decimals:this.decimals,decimalSeparator:this.decimalSeparator,orderSeparator:this.orderSeparator})}});u.IntegerCell=v.extend({className:"integer-cell",decimals:0});var w=u.DatetimeCell=g.extend({className:"datetime-cell",includeDate:m.prototype.defaults.includeDate,includeTime:m.prototype.defaults.includeTime,includeMilli:m.prototype.defaults.includeMilli,formatter:m,initialize:function(){g.prototype.initialize.apply(this,arguments),this.formatter=new this.formatter({includeDate:this.includeDate,includeTime:this.includeTime,includeMilli:this.includeMilli});var e=this.includeDate?"YYYY-MM-DD":"";e+=this.includeDate&&this.includeTime?"T":"",e+=this.includeTime?"HH:mm:ss":"",e+=this.includeTime&&this.includeMilli?".SSS":"",this.editor=this.editor.extend({attributes:i.extend({},this.editor.prototype.attributes,this.editor.attributes,{placeholder:e})})}});u.DateCell=w.extend({className:"date-cell",includeTime:!1}),u.TimeCell=w.extend({className:"time-cell",includeDate:!1}),u.BooleanCell=g.extend({className:"boolean-cell",editor:i.template("<input type='checkbox'<%= checked ? checked='checked' : '' %> />'"),events:{click:"enterEditMode","blur input[type=checkbox]":"exitEditMode","change input[type=checkbox]":"save"},render:function(){return this.$el.empty(),this.currentEditor=t(this.editor({checked:this.formatter.fromRaw(this.model.get(this.column.get("name")))})),this.$el.append(this.currentEditor),this},enterEditMode:function(){this.$el.addClass("editor"),this.currentEditor.focus()},exitEditMode:function(){this.$el.removeClass("editor")},save:function(){var e=this.formatter.toRaw(this.currentEditor.prop("checked"));this.model.set(this.column.get("name"),e)}});var y=u.SelectCellEditor=f.extend({tagName:"select",events:{change:"save",blur:"save"},template:i.template('<option value="<%= value %>" <%= selected ? \'selected="selected"\' : "" %>><%= text %></option>'),setOptionValues:function(e){this.optionValues=e},_renderOptions:function(e,t){for(var i="",n=0;e.length>n;n++)i+=this.template({text:e[n][0],value:e[n][1],selected:t===e[n][1]});return i},render:function(){this.$el.empty();var e=i.result(this,"optionValues"),n=this.model.get(this.column.get("name"));if(!i.isArray(e))throw TypeError("optionValues must be an array");for(var r=null,o=null,r=null,s=null,l=0;e.length>l;l++){var r=e[l];if(i.isArray(r))o=r[0],r=r[1],this.$el.append(this.template({text:o,value:r,selected:r===n}));else{if(!i.isObject(r))throw TypeError("optionValues elements must be a name-value pair or an object hash of { name: 'optgroup label', value: [option name-value pairs] }");s=r.name,optgroup=t("<optgroup></optgroup>",{label:s}),optgroup.append(this._renderOptions(r.values,n)),this.$el.append(optgroup)}}return this},save:function(){this.model.set(this.column.get("name"),this.formatter.toRaw(this.$el.val())),this.trigger("done")}});u.SelectCell=g.extend({className:"select-cell",editor:y,optionValues:void 0,initialize:function(){g.prototype.initialize.apply(this,arguments),l(this,["optionValues"]),this.optionValues=i.result(this,"optionValues"),this.on("edit",this.setOptionValues,this)},setOptionValues:function(e,t){t.setOptionValues(this.optionValues)},render:function(){this.$el.empty();var e=this.optionValues,t=this.formatter.fromRaw(this.model.get(this.column.get("name")));try{if(0==e||null==e)throw new TypeError;for(var n=0;e.length>n;n++){var r=e[n];if(i.isArray(r)){var o=r[0],r=r[1];if(r===t){this.$el.append(o);break}}else{if(!i.isObject(r))throw new TypeError;for(var s=r.values,l=0;s.length>l;l++){var a=s[l];if(a[1]===t){this.$el.append(a[0]);break}}}}}catch(h){if(h instanceof TypeError)throw TypeError("'optionValues' must be of type {Array.<Array>|Array.<{name: string, values: Array.<Array>}>}");throw h}return this}});var E=u.Column=n.Model.extend({defaults:{name:void 0,label:void 0,sortable:!0,editable:!0,renderable:!0,formatter:void 0,cell:void 0,headerCell:void 0},initialize:function(e){l(e,["cell","name"]),this.has("label")||this.set({label:this.get("name")},{silent:!0});var t=a(this.get("cell"),"Cell");this.set({cell:t},{silent:!0})}}),$=u.Columns=n.Collection.extend({model:E}),C=u.Row=n.View.extend({tagName:"tr",initialize:function(e){l(e,["columns","model"]),this.parent=e.parent,this.columns=e.columns,this.columns instanceof n.Collection||(this.columns=new $(this.columns)),this.columns.on("change:renderable",this.renderColumn,this),this.cells=[];var t=this;this.columns.each(function(e){var i=new(e.get("cell"))({parent:t,column:e,model:t.model});t.cells.push(i)})},dispose:function(){this.columns.off(null,null,this),this.parent&&this.parent.off&&this.parent.off(null,null,this);for(var e=0;this.cells.length>e;e++)this.cells[e].off(null,null,this);return n.View.prototype.dispose.apply(this,arguments)},renderColumn:function(e,t){var i=this.columns.indexOf(e);if(t){var n=this.cells[i];0===i?this.$el.prepend(n.render().$el):i===this.columns.length-1?this.$el.append(n.render().$el):this.$el.children().eq(i).before(n.render().$el)}else this.$el.children().eq(i).detach()},render:function(){this.$el.empty();for(var e=0;this.cells.length>e;e++){var t=this.cells[e];t.column.get("renderable")&&this.$el.append(t.render().$el)}return this}}),b=u.HeaderCell=n.View.extend({tagName:"th",events:{"click a":"triggerSort"},direction:null,initialize:function(e){this.parent=e.parent,this.column=e.column,!this.column instanceof E&&(this.column=new E(this.column))},dispose:function(){return this.parent&&this.parent.off&&this.parent.off(null,null,this),this.column.off(null,null,this),n.View.prototype.dispose.apply(this,arguments)},toggle:function(e,t){var i=this.$el.find("a");i.removeClass("ascending descending"),e===this.column.get("name")?(t&&i.addClass(t),this.direction=t):this.direction=null},triggerSort:function(e){e.preventDefault();var t=this,i=t.column.get("name");t.column.get("sortable")&&("ascending"===this.direction?t.trigger("sort",function(e,t){var n=e.get(i),r=t.get(i);return n===r?0:n>r?-1:1},i,"descending"):"descending"===this.direction?t.trigger("sort",null,i,null):t.trigger("sort",function(e,t){var n=e.get(i),r=t.get(i);return n===r?0:r>n?-1:1},i,"ascending"))},render:function(){this.$el.empty();var e=t("<a>").text(this.column.get("label")).append("<b class='sort-caret'></b>");return this.$el.append(e),this}}),x=u.Header=n.View.extend({tagName:"thead",initialize:function(e){var t=this;t.parent=e.parent,t.columns=e.columns,t.columns instanceof n.Collection||(t.columns=new $(t.columns)),t.cells=[],t.headerCell=e.headerCell||b;for(var i=0;t.columns.length>i;i++){var r=t.columns.at(i);if(r.get("renderable")){var o=r.get("headerCell")||t.headerCell,s=new o({parent:t,column:r});s.on("sort",t.dispatchSortEvent,t),t.cells.push(s)}}},dispose:function(){this.columns.off(null,null,this),this.parent&&this.parent.off&&this.parent.off(null,null,this);for(var e=null,t=0;this.cells.length>t;t++)e=this.cells[t],e.off(null,null,this),e.dispose();return n.View.prototype.dispose.apply(this,arguments)},dispatchSortEvent:function(e,t,n){this.parent.sort(e),i.each(this.cells,function(e){e.toggle(t,n)})},render:function(){var e=this;e.$el.empty();var n=t("<tr>");return i.each(e.cells,function(e){n.append(e.render().$el)}),e.$el.append(n),e}}),R=u.Body=n.View.extend({tagName:"tbody",initialize:function(e){l(e,["columns","collection"]);var t=this;t.parent=e.parent,t.columns=e.columns,t.columns instanceof n.Collection||(t.columns=new $(t.columns)),t.row=e.row||C,t.rows=t.collection.map(function(e){var i=new t.row({parent:t,columns:t.columns,model:e});return i}),t.collection.on("add",t.insertRow,t),t.collection.on("remove",t.removeRow,t),t.collection.on("reset",t.refresh,t)},dispose:function(){this.columns.off(null,null,this),this.parent&&this.parent.off&&this.parent.off(null,null,this);for(var e=null,t=0;this.rows.length>t;t++)e=this.rows[t],e.off(null,null,this),e.dispose();return n.View.prototype.dispose.apply(this,arguments)},sort:function(e){var t=this.collection.comparator;this.collection.comparator=e||this._idCidComparator,this.collection.sort(),this.collection.comparator=t},_idCidComparator:function(e,t){var n=e.id,r=e.cid,o=t.id,s=t.cid;if(i.isUndefined(n)&&i.isUndefined(o))if(i.isUndefined(n)||i.isUndefined(s))if(i.isUndefined(r)||i.isUndefined(o)){if(!i.isUndefined(r)&&!i.isUndefined(s)){if(s>r)return-1;if(r>s)return 1}}else{if(o>r)return-1;if(r>o)return 1}else{if(s>n)return-1;if(n>s)return 1}else{if(o>n)return-1;if(n>o)return 1}return 0},insertRow:function(e,t,n){if(n){var r=new this.row({parent:this,columns:this.columns,model:e});this.rows.splice(n.index,0,r),(i.isUndefined(n.render)||n.render)&&(n.index>=this.$el.children().length?this.$el.children().last().after(r.render().$el):this.$el.children().eq(n.index).before(r.render().$el))}else this.collection.add(e,n=t)},removeRow:function(e,t,n){n?((i.isUndefined(n.render)||n.render)&&this.rows[n.index].remove(),this.rows.splice(n.index,1)):this.collection.remove(e,n=t)},refresh:function(){var e=this;return i.each(e.rows,function(e){e.dispose()}),e.rows=e.collection.map(function(t){var i=new e.row({parent:e,columns:e.columns,model:t});return i}),e.render()},render:function(){var e=this;return e.$el.empty(),i.each(e.rows,function(t){e.$el.append(t.render().$el)}),this}});u.Footer=n.View.extend({tagName:"tfoot",initialize:function(e){l(e,["columns","collection"]),this.parent=e.parent,this.columns=e.columns,this.columns instanceof n.Collection||(this.columns=new u.Columns(this.columns))},dispose:function(){return this.columns.off(null,null,this),this.parent&&this.parent.off&&this.parent.off(null,null,this),n.View.prototype.dispose.apply(this,arguments)}}),u.Grid=n.View.extend({tagName:"table",className:"backgrid",initialize:function(e){this.columns=e.columns,this.columns instanceof n.Collection||(this.columns=new u.Columns(this.columns)),this.header=e.header||x,this.header=new this.header({parent:this,columns:this.columns,collection:this.collection}),this.body=e.body||R,this.body=new this.body({parent:this,columns:this.columns,collection:this.collection}),this.footer=e.footer||void 0,this.footer&&(this.footer=new this.footer({parent:this,columns:this.columns,collection:this.collection}))},dispose:function(){return this.columns.off(null,null,this),this.header.off(null,null,this),this.header.dispose(),this.body.off(null,null,this),this.body.dispose(),this.footer&&(this.footer.off(null,null,this),this.footer.dispose()),n.View.prototype.dispose.apply(this,arguments)},sort:function(e){return this.body.sort(e)},insertRow:function(e,t,i){return this.body.insertRow(e,t,i)},removeRow:function(e,t,i){return this.body.removeRow(e,t,i)},render:function(){return this.$el.empty(),this.$el.append(this.header.render().$el),this.footer&&this.$el.append(this.footer.render().$el),this.$el.append(this.body.render().$el),this.trigger("rendered"),this}})})(this,$,_,Backbone);