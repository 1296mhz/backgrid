/*
  backgrid
  http://github.com/wyuenho/backgrid

  Copyright (c) 2012 Jimmy Yuen Ho Wong
  Licensed under the MIT @license.
*/
(function(e){function t(e){return String.prototype.trim?String.prototype.trim.call(e,e):e.replace(/^\s+|\s+$/g,"")}function i(e){return String.fromCharCode(e.charCodeAt(0)-32)+e.slice(1)}function r(e,t,i){var r=t-(e+"").length;r=0>r?0:r;for(var n="",o=0;r>o;o++)n+=i;return n+e}var n=n||function(e){throw new ReferenceError(e+" is required but missing.")},o=e.jQuery||e.Zepto||e.ender,l=e._||n("underscore"),s=e.Backbone||n("backbone");s.View.prototype.dispose||l.extend(s.View.prototype,{dispose:function(){return this.undelegateEvents(),this.model&&this.model.off&&this.model.off(null,null,this),this.collection&&this.collection.off&&this.collection.off(null,null,this),this},remove:function(){return this.dispose(),this.$el.remove(),this}});var a=e.Backgrid={};a.VERSION="0.1";var c=a.Formatter=function(){};l.extend(c.prototype,{fromRaw:function(e){return e},toRaw:function(e){return e}});var d=a.NumberFormatter=function(e){if(e=e?l.clone(e):{},l.extend(this,this.defaults,e),0>this.decimals||this.decimals>20)throw new RangeError("decimals must be between 0 and 20")};d.prototype=new c,l.extend(d.prototype,{defaults:{decimals:2,decimalSeparator:".",orderSeparator:","},HUMANIZED_NUM_RE:/(\d)(?=(?:\d{3})+$)/g,fromRaw:function(e){if(isNaN(e)||null===e)return"";e=e.toFixed(~~this.decimals);var t=e.split("."),i=t[0],r=t[1]?(this.decimalSeparator||".")+t[1]:"";return i.replace(this.HUMANIZED_NUM_RE,"$1"+this.orderSeparator)+r},toRaw:function(e){for(var i="",r=t(e).split(this.orderSeparator),n=0;r.length>n;n++)i+=r[n];var o=i.split(this.decimalSeparator);i="";for(var n=0;o.length>n;n++)i=i+o[n]+".";"."===i[i.length-1]&&(i=i.slice(0,i.length-1));var s=1*(1*i).toFixed(~~this.decimals);return l.isNumber(s)&&!l.isNaN(s)?s:void 0}});var u=a.DatetimeFormatter=function(e){if(e=e?l.clone(e):{},l.extend(this,this.defaults,e),!this.includeDate&&!this.includeTime)throw Error("Either includeDate or includeTime must be true")};u.prototype=new c,l.extend(u.prototype,{defaults:{includeDate:!0,includeTime:!0,includeMilli:!1},DATE_RE:/^([+\-]?\d{4})-(\d{2})-(\d{2})$/,TIME_RE:/^(\d{2}):(\d{2}):(\d{2})(\.\d{3})?$/,ZONE_RE:/^([+\-]\d{2}):?(\d{2})$/,ISO_SPLITTER_RE:/T|Z| +/,fromRaw:function(e){e=t(e);var i=e.split(this.ISO_SPLITTER_RE)||[],n=this.includeDate?i[0]:"",o=this.includeDate?i[1]:i[0]||"",l=this.includeDate?i[2]:i[1]||"",s=this.DATE_RE.exec(n)||[],a=this.TIME_RE.exec(o)||[],c=this.ZONE_RE.exec(l)||[];c[1]=1*c[1]||0,c[2]=1*c[2]||0;var d=new Date(Date.UTC(1*s[1]||0,1*s[2]-1||0,1*s[3]||0,(1*a[1]||null)+c[1],(1*a[2]||null)+c[2],1*a[3]||null,1*a[4]||null)),u="";return this.includeDate&&(u=r(d.getFullYear(),4,0)+"-"+r(d.getMonth()+1,2,0)+"-"+r(d.getDate(),2,0)),this.includeTime&&(u=u+" "+r(d.getHours(),2,0)+":"+r(d.getMinutes(),2,0)+":"+r(d.getSeconds(),2,0),this.includeMilli&&(u=u+"."+r(d.getMilliseconds(),3,0))),u},toRaw:function(e){e=t(e);var i=e.split(this.ISO_SPLITTER_RE)||[],n=this.includeDate?i[0]:"",o=this.includeDate?i[1]:i[0]||"",l=this.includeDate?i[2]:i[1]||"",s=this.DATE_RE.exec(n)||[],a=this.TIME_RE.exec(o)||[],c=this.ZONE_RE.exec(l)||[];if(this.includeDate&&s[0]===void 0)return void 0;if(this.includeTime&&a[0]===void 0)return void 0;if(!this.includeDate&&n)return void 0;if(!this.includeTime&&o)return void 0;var d=null;c!==[]?(c[1]=1*c[1]||0,c[2]=1*c[2]||0,d=new Date(Date.UTC(1*s[1]||0,1*s[2]-1||0,1*s[3]||0,(1*a[1]||null)+c[1],(1*a[2]||null)+c[2],1*a[3]||null,1*a[4]||null))):d=new Date(1*s[1]||0,1*s[2]-1||0,1*s[3]||0,1*a[1]||null,1*a[2]||null,1*a[3]||null,1*a[4]||null);var u="";return this.includeDate&&(u=r(d.getUTCFullYear(),4,0)+"-"+r(d.getUTCMonth()+1,2,0)+"-"+r(d.getUTCDate(),2,0)),this.includeTime&&(u=u+"T"+r(d.getUTCHours(),2,0)+":"+r(d.getUTCMinutes(),2,0)+":"+r(d.getUTCSeconds(),2,0),this.includeMilli&&(u=u+"."+r(d.getUTCMilliseconds(),3,0)),u+="Z"),u}});var h=a.CellEditor=s.View.extend({initialize:function(e){if(s.View.prototype.initialize.apply(this,arguments),this.formatter=e.formatter,this.column=e.column,!this.formatter)throw Error("formatter is required");if(!this.column)throw Error("column is required")},postRender:function(){return this.$el.focus(),this}}),m=a.DivCellEditor=h.extend({tagName:"div",attributes:{contenteditable:"true"},events:{blur:"saveOrCancel",keydown:"saveOrCancel"},initialize:function(){h.prototype.initialize.apply(this,arguments),this.on("done",this.remove,this)},render:function(){return this.$el.text(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this},postRender:function(){if(this.$el.focus(),window.getSelection!==void 0&&document.createRange!==void 0){var e=document.createRange();e.selectNodeContents(this.el),e.collapse(!1);var t=window.getSelection();t.removeAllRanges(),t.addRange(e)}if(document.body.createTextRange!==void 0){var i=document.body.createTextRange();i.moveToElementText(this.el),i.collapse(!1),i.select()}return this},saveOrCancel:function(e){if("keydown"===e.type)if(13===e.keyCode||9===e.keyCode){e.preventDefault();var t=this.formatter.toRaw(this.$el.text());if(t===void 0)return this.trigger("error"),void 0;this.model.set(this.column.get("name"),t)?this.trigger("done"):this.trigger("error")}else 27===e.keyCode&&(e.stopPropagation(),this.$el.text(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this.trigger("done"));else"blur"===e.type&&(this.$el.text(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this.trigger("done"))},remove:function(){if(s.View.prototype.remove.apply(this,arguments),window.getSelection!==void 0){var e=window.getSelection();e.removeAllRanges()}return this}}),p=a.Cell=s.View.extend({tagName:"td",formatter:new c,editor:m,events:{click:"enterEditMode"},initialize:function(e){s.View.prototype.initialize.apply(this,arguments),this.formatter=e&&e.formatter||this.formatter,this.editor=e&&e.editor||this.editor,this.column=e&&e.column},render:function(){return this.$el.empty().text(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this},enterEditMode:function(){this.column.get("editable")&&(this.currentEditor=new this.editor({column:this.column,model:this.model,formatter:this.formatter}),this.currentEditor.on("done",this.exitEditMode,this),this.currentEditor.on("error",this.renderError,this),this.$el.empty(),this.undelegateEvents(),this.$el.append(this.currentEditor.render().$el),this.currentEditor.postRender(),this.$el.addClass("editor"))},renderError:function(){this.$el.addClass("error")},exitEditMode:function(){this.$el.removeClass("error"),this.currentEditor.remove(),delete this.currentEditor,this.$el.removeClass("editor"),this.render(),this.delegateEvents()},remove:function(){s.View.prototype.remove.apply(this,arguments),this.currentEditor&&(this.currentEditor.remove(),delete this.currentEditor)}});a.StringCell=p.extend({className:"string-cell",formatter:{fromRaw:function(e){return l.escape(e)},toRaw:function(e){return e}}}),a.UriCell=p.extend({className:"uri-cell",formatter:{fromRaw:function(e){return e},toRaw:function(e){return encodeURI(e)}},render:function(){this.$el.empty();var e=this.formatter.fromRaw(this.model.get(this.column.get("name")));return this.$el.append(o("<a>",{href:e,title:e,target:"_blank"}).text(e)),this}}),a.EmailCell=p.extend({className:"email-cell",formatter:{fromRaw:function(e){return e},toRaw:function(e){return-1===e.indexOf("@")?void 0:e}},render:function(){this.$el.empty();var e=this.formatter.fromRaw(this.model.get(this.column.get("name")));return this.$el.append(o("<a>",{href:"mailto:"+e,title:e,target:"_blank"}).text(e)),this}});var f=a.NumberCell=p.extend({className:"number-cell",decimals:d.prototype.defaults.decimals,decimalSeparator:d.prototype.defaults.decimalSeparator,orderSeparator:d.prototype.defaults.orderSeparator,initialize:function(e){p.prototype.initialize.apply(this,arguments),e&&(this.decimals=e.decimals!==void 0?e.decimals:this.decimals,this.decimalSeparator=e.decimalSeparator!==void 0?e.decimalSeparator:this.decimalSeparator,this.orderSeparator=e.orderSeparator!==void 0?e.orderSeparator:this.orderSeparator),this.formatter=e&&e.formatter||new d({decimals:this.decimals,decimalSeparator:this.decimalSeparator,orderSeparator:this.orderSeparator})}});a.IntegerCell=f.extend({className:"integer-cell",decimals:0});var g=a.DatetimeCell=p.extend({className:"datetime-cell",includeDate:u.prototype.defaults.includeDate,includeTime:u.prototype.defaults.includeTime,initialize:function(e){p.prototype.initialize.apply(this,arguments),e&&(this.includeDate=e.includeDate!==void 0?e.includeDate:this.includeDate,this.includeTime=e.includeTime!==void 0?e.includeTime:this.includeTime),this.formatter=e&&e.formatter||new u({includeDate:this.includeDate,includeTime:this.includeTime})}});a.DateCell=g.extend({className:"date-cell",includeTime:!1}),a.TimeCell=g.extend({className:"time-cell",includeDate:!1}),a.BooleanCell=p.extend({className:"boolean-cell",editor:l.template("<input type='checkbox'<%= checked ? checked='checked' : '' %> />'"),events:{click:"enterEditMode","blur input[type=checkbox]":"exitEditMode","change input[type=checkbox]":"save"},render:function(){return this.currentEditor=o(this.editor({checked:this.formatter.fromRaw(this.model.get(this.column.get("name")))})),this.$el.append(this.currentEditor),this},enterEditMode:function(){this.$el.addClass("editor"),this.currentEditor.focus()},exitEditMode:function(){this.$el.removeClass("editor")},save:function(){var e=this.formatter.toRaw(this.currentEditor.prop("checked"));this.model.set(this.column.get("name"),e)}});var v=a.SelectCellEditor=h.extend({tagName:"select",events:{change:"save",blur:"save"},initialize:function(e){h.prototype.initialize.apply(this,arguments),this.optionValues=e.optionValues},_renderOptions:function(e){for(var t="",i=0;e.length>i;i++)t=t+"<option value='"+e[i][0]+"'>"+e[i][1]+"</option>";return t},render:function(){var e=l.result(this,"optionValues");if(!l.isArray(e))throw TypeError("optionValues must be an array");for(var t=null,i=null,t=null,r=null,n=0;e.length>n;n++){var t=e[n];if(l.isArray(t))i=t[0],t=t[1],this.$el.append(o("<option value='"+t+"'>"+i+"</option>"));else{if(!l.isObject(t))throw TypeError("optionValues elements must be a name-value pair or an object hash of { name: 'optgroup label', value: [option name-value pairs] }");r=t.name,optgroup=o("<optgroup></optgroup>",{label:r}),optgroup.append(this._renderOptions(t.value)),this.$el.append(optgroup)}}return this},save:function(){this.model.set(this.colume.get("name"),this.$el.val()),this.trigger("done")}});a.SelectCell=p.extend({className:"select-cell",editor:v,initialize:function(e){if(p.prototype.initialize.apply(this,arguments),this.optionValues=e.optionValues,!optionValues)throw Error("optionValues is required")},enterEditMode:function(){p.prototype.enterEditMode.apply(this,arguments),this.currentEditor.initialize({formatter:this.formatter,column:this.column,model:this.model,optionValues:this.optionValues})}});var w=a.Column=s.Model.extend({defaults:{name:null,label:null,sortable:!0,editable:!0,renderable:!0,formatter:null,cell:null},initialize:function(e){if(this.has("label")||this.set({label:this.get("name")},{silent:!0}),!e.cell)throw Error("cell is required");if(!e.name)throw Error("name is required");if("string"==typeof e.cell){var t=a[i(this.get("cell"))+"Cell"];if(t===void 0)throw new ReferenceError("Cell type '"+e.cell+"' not found");this.set({cell:t},{silent:!0})}else this.set({cell:e.cell},{silent:!0})}}),y=a.Columns=s.Collection.extend({model:w}),E=a.Row=s.View.extend({tagName:"tr",initialize:function(e){var t=this;t.parent=e.parent,t.columns=e.columns,t.columns instanceof s.Collection||(t.columns=new y(t.columns)),t.cells=[],t.columns.each(function(e){if(e.get("renderable")){var i=e.get("cell");i=new i({column:e,model:t.model}),t.cells.push(i)}})},dispose:function(){s.View.prototype.dispose.apply(this,arguments),this.columns.off(null,null,this),this.parent&&this.parent.off&&this.parent.off(null,null,this);for(var e=null,t=0;this.cells.length>t;t++)e=this.cells[t],e.off(null,null,this),e.dispose();return this},render:function(){this.$el.empty();for(var e=0;this.cells.length>e;e++)this.$el.append(this.cells[e].render().$el);return this}}),x=a.HeaderCell=s.View.extend({tagName:"th",events:{"click a":"triggerSort"},direction:null,initialize:function(e){this.parent=e.parent,this.column=e.column,!this.column instanceof w&&(this.column=new w(this.column))},dispose:function(){return s.View.prototype.dispose.apply(this,arguments),this.parent&&this.parent.off&&this.parent.off(null,null,this),this.column.off(null,null,this),this},toggle:function(e,t){var i=this.$el.find("a");i.removeClass("ascending descending"),e===this.column.get("name")?(t&&i.addClass(t),this.direction=t):this.direction=null},triggerSort:function(e){e.preventDefault();var t=this,i=t.column.get("name");t.column.get("sortable")&&("ascending"===this.direction?t.trigger("sort",function(e,t){var r=e.get(i),n=t.get(i);return r===n?0:r>n?-1:1},i,"descending"):"descending"===this.direction?t.trigger("sort",null,i,null):t.trigger("sort",function(e,t){var r=e.get(i),n=t.get(i);return r===n?0:n>r?-1:1},i,"ascending"))},render:function(){this.$el.empty();var e=o("<a>").text(this.column.get("label")).append("<b class='sort-caret'></b>");return this.$el.append(e),this}}),R=a.Header=s.View.extend({tagName:"thead",initialize:function(e){var t=this;t.parent=e.parent,t.columns=e.columns,t.columns instanceof s.Collection||(t.columns=new y(t.columns)),t.cells=[];for(var i=0;t.columns.length>i;i++){var r=t.columns.at(i);if(r.get("renderable")){var n=new x({parent:t,column:r});n.on("sort",t.dispatchSortEvent,t),t.cells.push(n)}}},dispose:function(){s.View.prototype.dispose.apply(this,arguments),this.columns.off(null,null,this),this.parent&&this.parent.off&&this.parent.off(null,null,this);for(var e=null,t=0;this.cells.length>t;t++)e=this.cells[t],e.off(null,null,this),e.dispose();return this},dispatchSortEvent:function(e,t,i){this.parent.sort(e),l.each(this.cells,function(e){e.toggle(t,i)})},render:function(){var e=this;e.$el.empty();var t=o("<tr>");return l.each(e.cells,function(e){t.append(e.render().$el)}),e.$el.append(t),e}}),b=a.Body=s.View.extend({tagName:"tbody",initialize:function(e){var t=this;t.parent=e.parent,t.columns=e.columns,t.columns instanceof s.Collection||(t.columns=new y(t.columns)),this.row=e.row||E,t.rows=t.collection.map(function(e){var i=new t.row({parent:t,columns:t.columns,model:e});return i}),t.collection.on("add",t.insertRow,t),t.collection.on("remove",t.removeRow,t),t.collection.on("reset",t.refresh,t),t.collection.comparator||(t.collection.comparator=t._idCidComparator)},dispose:function(){s.View.prototype.dispose.apply(this,arguments),this.columns.off(null,null,this),this.parent&&this.parent.off&&this.parent.off(null,null,this);for(var e=null,t=0;this.rows.length>t;t++)e=this.rows[t],e.off(null,null,this),e.dispose();return this},sort:function(e){this.collection.comparator=e||this._idCidComparator,this.collection.sort()},_idCidComparator:function(e,t){var i=e.id,r=e.cid,n=t.cid,o=t.rcid;if(i&&n){if(n>i)return-1;if(i>n)return-1}else if(i&&o){if(o>i)return-1;if(i>o)return 1}else if(r&&n){if(n>r)return-1;if(r>n)return 1}else if(r&&o){if(o>r)return-1;if(r>o)return 1}return 0},insertRow:function(e,t,i){if(i){var r=new E({parent:this,columns:this.columns,model:e});this.rows.splice(i.index,0,r),(i.render===void 0||i.render)&&(i.index>=this.$el.children().length?this.$el.children().last().after(r.render().$el):this.$el.children().eq(i.index).before(r.render().$el))}else this.collection.add(e,i=t)},removeRow:function(e,t,i){i?((i.render===void 0||i.render)&&this.rows[i.index].remove(),this.rows.splice(i.index,1)):this.collection.remove(e,i=t)},refresh:function(){var e=this;return e.rows=e.collection.map(function(t){var i=new E({parent:e,columns:e.columns,model:t});return i}),e.render()},render:function(){var e=this;return e.$el.empty(),l.each(e.rows,function(t){e.$el.append(t.render().$el)}),this}});a.Footer=s.View.extend({tagName:"tfoot"}),a.Grid=s.View.extend({tagName:"table",className:"backgrid",initialize:function(e){this.columns=e.columns,this.header=e.header||R,this.header=new this.header({parent:this,columns:this.columns,collection:this.collection}),this.body=e.body||b,this.body=new this.body({parent:this,columns:this.columns,collection:this.collection}),this.footer=e.footer||void 0,this.footer&&(this.footer=new this.footer({parent:this,columns:this.columns,collection:this.collection}))},dispose:function(){return s.View.prototype.dispose.apply(this,arguments),this.columns.off(null,null,this),this.header.off(null,null,this),this.header.dispose(),this.body.off(null,null,this),this.body.dispose(),this.footer&&(this.footer.off(null,null,this),this.footer.dispose()),this},sort:function(e){this.body.sort(e)},render:function(){return this.$el.empty(),this.$el.append(this.header.render().$el),this.footer&&this.$el.append(this.footer.render().$el),this.$el.append(this.body.render().$el),this.trigger("rendered"),this}})})(this);