/*
  backgrid
  http://github.com/wyuenho/backgrid

  Copyright (c) 2013 Jimmy Yuen Ho Wong and contributors
  Licensed under the MIT @license.
*/
(function(e,t,i,n){"use strict";function r(e){return String.fromCharCode(e.charCodeAt(0)-32)+e.slice(1)}function o(e,t,i){var n=t-(e+"").length;n=0>n?0:n;for(var r="",o=0;n>o;o++)r+=i;return r+e}var s=e,l="	\n\f\r   ᠎             　\u2028\u2029﻿";if(!String.prototype.trim||l.trim()){l="["+l+"]";var a=new RegExp("^"+l+l+"*"),h=new RegExp(l+l+"*$");String.prototype.trim=function(){if(void 0===this||null===this)throw new TypeError("can't convert "+this+" to object");return String(this).replace(a,"").replace(h,"")}}var c=e.Backgrid={VERSION:"0.2.6",Extension:{},requireOptions:function(e,t){for(var n=0;n<t.length;n++){var r=t[n];if(i.isUndefined(e[r]))throw new TypeError("'"+r+"' is required")}},resolveNameToClass:function(e,t){if(i.isString(e)){var n=i.map(e.split("-"),function(e){return r(e)}).join("")+t,o=c[n]||c.Extension[n];if(i.isUndefined(o))throw new ReferenceError("Class '"+n+"' not found");return o}return e}};i.extend(c,n.Events);var d=c.Command=function(e){i.extend(this,{altKey:!!e.altKey,"char":e.char,charCode:e.charCode,ctrlKey:!!e.ctrlKey,key:e.key,keyCode:e.keyCode,locale:e.locale,location:e.location,metaKey:!!e.metaKey,repeat:!!e.repeat,shiftKey:!!e.shiftKey,which:e.which})};i.extend(d.prototype,{moveUp:function(){return this.keyCode==38},moveDown:function(){return this.keyCode===40},moveLeft:function(){return this.shiftKey&&this.keyCode===9},moveRight:function(){return!this.shiftKey&&this.keyCode===9},save:function(){return this.keyCode===13},cancel:function(){return this.keyCode===27},passThru:function(){return!(this.moveUp()||this.moveDown()||this.moveLeft()||this.moveRight()||this.save()||this.cancel())}});var u=["model","collection","el","id","attributes","className","tagName","events","use$"],m=c.View=function(e){this.cid=i.uniqueId("view"),e=e||{},i.extend(this,i.pick(e,u)),this._ensureElement(e),this.initialize.apply(this,arguments),this.delegateEvents()},f=/^(\S+)\s*(.*)$/;i.extend(c.View.prototype,n.Events,{use$:!0,tagName:"div",$:function(e){return this.$el?this.$el.find(e):this.el.querySelectorAll(e)},initialize:function(){},render:function(){return this},show:function(){return this.el.style.display="",this},hide:function(){return this.el.style.display="none",this},empty:function(){for(var e=this.el;e.firstChild;)e.removeChild(e.firstChild);return this},remove:function(){if(this.$el)this.$el.remove();else if(this.el){var e=this.el.parentNode;e&&e.removeChild(this.el)}return this.stopListening(),this},setElement:function(e,t){t=i.extend({use$:n.$&&this.use$,delegate:!0},t||{});var r=t.delegate;if(this.$el&&this.undelegateEvents(),t.use$)this.$el=e instanceof n.$?e:n.$(e),this.el=this.$el[0];else if("string"==typeof e)if(e[0]=="<"){var o=s.document.createElement("div");o.innerHTML=e,this.el=o.firstChild}else this.el=s.document.querySelector(e);else this.el=e;return r!==!1&&this.delegateEvents(),this},_processEvents:function(e,t){for(var n in e){var r=e[n];if(i.isFunction(r)||(r=this[e[n]]),r){r=i.bind(r,this);var o=n.match(f);t(o[1],o[2],r)}}},delegateEvents:function(e){if(!e&&!(e=i.result(this,"events")))return this;this.undelegateEvents();var t=this.el,n=this.$el,r=this.cid;return this._processEvents(e,function(e,i,o){var s=e+".delegateEvents"+r;if(""===i)n?n.on(s,o):t&&(t.addEventListener?t.addEventListener(e,o):t.attachEvent&&t.attachEvent("on"+e,o));else if(n)n.on(s,i,o);else if(t)for(var l=t.querySelectorAll(i),a=0,h=l.length;h>a;a++){var c=l[a];t.addEventListener?c.addEventListener(e,o):t.attachEvent&&c.attachEvent("on"+e,o)}}),this},undelegateEvents:function(){var e=this.el,t=this.$el;if(t)this.$el.off(".delegateEvents"+this.cid);else if(e){var n=i.result(this,"events");if(!n)return this;this._processEvents(n,function(t,i,n){if(""===i)e.removeEventListener?e.removeEventListener(t,n):e.detachEvent&&e.detachEvent("on"+t,n);else for(var r=e.querySelectorAll(i),o=0,s=r.length;s>o;o++){var l=r[o];e.removeEventListener?l.removeEventListener(t,n):e.detachEvent&&l.detachEvent("on"+t,n)}})}return this},_ensureElement:function(e){if(e=i.extend(e,{delegate:!1}),this.el)this.setElement(i.result(this,"el"),e);else{var t=this.el=s.document.createElement(i.result(this,"tagName")),n=i.extend({},i.result(this,"attributes"));this.id&&(n.id=i.result(this,"id")),this.className&&(n["class"]=i.result(this,"className"));for(var r in n)t.setAttribute(r,n[r]);this.setElement(t,e)}}}),m.extend=n.View.extend;var p=c.CellFormatter=function(){};i.extend(p.prototype,{fromRaw:function(e){return e},toRaw:function(e){return e}});var v=c.NumberFormatter=function(e){if(e=e?i.clone(e):{},i.extend(this,this.defaults,e),this.decimals<0||this.decimals>20)throw new RangeError("decimals must be between 0 and 20")};v.prototype=new p,i.extend(v.prototype,{defaults:{decimals:2,decimalSeparator:".",orderSeparator:","},HUMANIZED_NUM_RE:/(\d)(?=(?:\d{3})+$)/g,fromRaw:function(e){if(i.isNull(e)||i.isUndefined(e))return"";e=e.toFixed(~~this.decimals);var t=e.split("."),n=t[0],r=t[1]?(this.decimalSeparator||".")+t[1]:"";return n.replace(this.HUMANIZED_NUM_RE,"$1"+this.orderSeparator)+r},toRaw:function(e){for(var t="",n=e.trim().split(this.orderSeparator),r=0;r<n.length;r++)t+=n[r];var o=t.split(this.decimalSeparator);t="";for(var r=0;r<o.length;r++)t=t+o[r]+".";t[t.length-1]==="."&&(t=t.slice(0,t.length-1));var s=(1*t).toFixed(~~this.decimals)*1;return i.isNumber(s)&&!i.isNaN(s)?s:void 0}});var g=c.DatetimeFormatter=function(e){if(e=e?i.clone(e):{},i.extend(this,this.defaults,e),!this.includeDate&&!this.includeTime)throw new Error("Either includeDate or includeTime must be true")};g.prototype=new p,i.extend(g.prototype,{defaults:{includeDate:!0,includeTime:!0,includeMilli:!1},DATE_RE:/^([+\-]?\d{4})-(\d{2})-(\d{2})$/,TIME_RE:/^(\d{2}):(\d{2}):(\d{2})(\.(\d{3}))?$/,ISO_SPLITTER_RE:/T|Z| +/,_convert:function(e,t){var n,r=null;if(i.isNumber(e)){var s=new Date(e);n=o(s.getUTCFullYear(),4,0)+"-"+o(s.getUTCMonth()+1,2,0)+"-"+o(s.getUTCDate(),2,0),r=o(s.getUTCHours(),2,0)+":"+o(s.getUTCMinutes(),2,0)+":"+o(s.getUTCSeconds(),2,0)}else{e=e.trim();var l=e.split(this.ISO_SPLITTER_RE)||[];n=this.DATE_RE.test(l[0])?l[0]:"",r=n&&l[1]?l[1]:this.TIME_RE.test(l[0])?l[0]:""}var a=this.DATE_RE.exec(n)||[],h=this.TIME_RE.exec(r)||[];if(t){if(this.includeDate&&i.isUndefined(a[0]))return;if(this.includeTime&&i.isUndefined(h[0]))return;if(!this.includeDate&&n)return;if(!this.includeTime&&r)return}var s=new Date(Date.UTC(a[1]*1||0,a[2]*1-1||0,a[3]*1||0,h[1]*1||null,h[2]*1||null,h[3]*1||null,h[5]*1||null)),c="";return this.includeDate&&(c=o(s.getUTCFullYear(),4,0)+"-"+o(s.getUTCMonth()+1,2,0)+"-"+o(s.getUTCDate(),2,0)),this.includeTime&&(c=c+(this.includeDate?"T":"")+o(s.getUTCHours(),2,0)+":"+o(s.getUTCMinutes(),2,0)+":"+o(s.getUTCSeconds(),2,0),this.includeMilli&&(c=c+"."+o(s.getUTCMilliseconds(),3,0))),this.includeDate&&this.includeTime&&(c+="Z"),c},fromRaw:function(e){return i.isNull(e)||i.isUndefined(e)?"":this._convert(e)},toRaw:function(e){return this._convert(e,!0)}});var y=c.StringFormatter=function(){};y.prototype=new p,i.extend(y.prototype,{fromRaw:function(e){return i.isUndefined(e)||i.isNull(e)?"":e+""}});var w=c.EmailFormatter=function(){};w.prototype=new p,i.extend(w.prototype,{toRaw:function(e){var t=e.trim().split("@");return t.length===2&&i.all(t)?e:void 0}});var E=c.SelectFormatter=function(){};E.prototype=new p,i.extend(E.prototype,{fromRaw:function(e){return i.isArray(e)?e:null!=e?[e]:[]}});var C=c.CellEditor=c.View.extend({initialize:function(e){c.requireOptions(e,["formatter","column","model"]),this.formatter=e.formatter,this.column=e.column,this.column instanceof S||(this.column=new S(this.column)),this.listenTo(this.model,"backgrid:editing",this.postRender)},postRender:function(e,t){return(null==t||t.get("name")==this.column.get("name"))&&this.el.focus(),this}}),b=c.InputCellEditor=C.extend({tagName:"input",attributes:{type:"text"},events:{blur:"saveOrCancel",keydown:"saveOrCancel"},initialize:function(e){C.prototype.initialize.apply(this,arguments),e.placeholder&&this.el.setAttribute("placeholder",e.placeholder)},render:function(){return this.el.value=this.formatter.fromRaw(this.model.get(this.column.get("name"))),this},saveOrCancel:function(e){var t=this.formatter,n=this.model,r=this.column,o=new d(e),s=e.type==="blur";if(o.moveUp()||o.moveDown()||o.moveLeft()||o.moveRight()||o.save()||s){e.preventDefault(),e.stopPropagation();var l=this.el.value,a=t.toRaw(l);i.isUndefined(a)?n.trigger("backgrid:error",n,r,l):(n.set(r.get("name"),a),n.trigger("backgrid:edited",n,r,o))}else o.cancel()&&(e.stopPropagation(),n.trigger("backgrid:edited",n,r,o))},postRender:function(e,t){if(null==t||t.get("name")==this.column.get("name")){var i,n=this.el;if(s.getComputedStyle?i=s.getComputedStyle(n).textAlign:n.currentStyle&&(i=n.currentStyle.textAlign),"right"===i){var r=n.value;n.focus(),n.val=null,n.val=r}else n.focus()}return this}}),x=c.Cell=c.View.extend({tagName:"td",formatter:new p,editor:b,events:{click:"enterEditMode"},initialize:function(e){c.requireOptions(e,["model","column"]),this.column=e.column,this.column instanceof S||(this.column=new S(this.column)),this.formatter=c.resolveNameToClass(this.column.get("formatter")||this.formatter,"Formatter"),this.editor=c.resolveNameToClass(this.editor,"CellEditor"),this.listenTo(this.model,"change:"+this.column.get("name"),function(){this.el.classList.contains("editor")||this.render()}),this.listenTo(this.model,"backgrid:error",this.renderError)},render:function(){return this.empty(),this.el.appendChild(s.document.createTextNode(this.formatter.fromRaw(this.model.get(this.column.get("name"))))),this.delegateEvents(),this},enterEditMode:function(){var e=this.model,t=this.column;t.get("editable")&&(this.currentEditor=new this.editor({column:this.column,model:this.model,formatter:this.formatter}),e.trigger("backgrid:edit",e,t,this,this.currentEditor),this.undelegateEvents(),this.empty(),this.el.appendChild(this.currentEditor.el),this.currentEditor.render(),this.el.classList.add("editor"),e.trigger("backgrid:editing",e,t,this,this.currentEditor))},renderError:function(e,t){(null==t||t.get("name")==this.column.get("name"))&&this.el.classList.add("error")},exitEditMode:function(){this.el.classList.remove("error"),this.currentEditor.remove(),this.stopListening(this.currentEditor),delete this.currentEditor,this.el.classList.remove("editor"),this.render()},remove:function(){return this.currentEditor&&(this.currentEditor.remove.apply(this.currentEditor,arguments),delete this.currentEditor),c.View.prototype.remove.apply(this,arguments)}}),T=c.StringCell=x.extend({className:"string-cell",formatter:new y});c.UriCell=x.extend({className:"uri-cell",render:function(){this.empty();var e=this.formatter.fromRaw(this.model.get(this.column.get("name"))),t=s.document,i=t.createElement("a");return i.tabIndex=-1,i.href=e,i.title=e,i.target="_blank",i.appendChild(t.createTextNode(e)),this.el.appendChild(i),this.delegateEvents(),this}}),c.EmailCell=T.extend({className:"email-cell",formatter:new w,render:function(){this.empty();var e=this.formatter.fromRaw(this.model.get(this.column.get("name"))),t=s.document,i=t.createElement("a");return i.tabIndex=-1,i.href="mailto:"+e,i.title=e,i.appendChild(t.createTextNode(e)),this.el.appendChild(i),this.delegateEvents(),this}});var R=c.NumberCell=x.extend({className:"number-cell",decimals:v.prototype.defaults.decimals,decimalSeparator:v.prototype.defaults.decimalSeparator,orderSeparator:v.prototype.defaults.orderSeparator,formatter:v,initialize:function(){x.prototype.initialize.apply(this,arguments),this.formatter=new this.formatter({decimals:this.decimals,decimalSeparator:this.decimalSeparator,orderSeparator:this.orderSeparator})}});c.IntegerCell=R.extend({className:"integer-cell",decimals:0});var N=c.DatetimeCell=x.extend({className:"datetime-cell",includeDate:g.prototype.defaults.includeDate,includeTime:g.prototype.defaults.includeTime,includeMilli:g.prototype.defaults.includeMilli,formatter:g,initialize:function(){x.prototype.initialize.apply(this,arguments),this.formatter=new this.formatter({includeDate:this.includeDate,includeTime:this.includeTime,includeMilli:this.includeMilli});var e=this.includeDate?"YYYY-MM-DD":"";e+=this.includeDate&&this.includeTime?"T":"",e+=this.includeTime?"HH:mm:ss":"",e+=this.includeTime&&this.includeMilli?".SSS":"",this.editor=this.editor.extend({attributes:i.extend({},this.editor.prototype.attributes,this.editor.attributes,{placeholder:e})})}});c.DateCell=N.extend({className:"date-cell",includeTime:!1}),c.TimeCell=N.extend({className:"time-cell",includeDate:!1});var k=c.BooleanCellEditor=C.extend({tagName:"input",attributes:{tabIndex:-1,type:"checkbox"},events:{mousedown:function(){this.mouseDown=!0},blur:"enterOrExitEditMode",mouseup:function(){this.mouseDown=!1},change:"saveOrCancel",keydown:"saveOrCancel"},render:function(){var e=this.formatter.fromRaw(this.model.get(this.column.get("name")));return this.el.checked=e,this},enterOrExitEditMode:function(e){if(!this.mouseDown){var t=this.model;t.trigger("backgrid:edited",t,this.column,new d(e))}},saveOrCancel:function(e){var t=this.model,i=this.column,n=this.formatter,r=new d(e);if(r.passThru()&&e.type!="change")return!0;r.cancel()&&(e.stopPropagation(),t.trigger("backgrid:edited",t,i,r));var o=this.el;if(r.save()||r.moveLeft()||r.moveRight()||r.moveUp()||r.moveDown()){e.preventDefault(),e.stopPropagation();var s=n.toRaw(o.checked);t.set(i.get("name"),s),t.trigger("backgrid:edited",t,i,r)}else if(e.type=="change"){var s=n.toRaw(o.checked);t.set(i.get("name"),s),o.focus()}}});c.BooleanCell=x.extend({className:"boolean-cell",editor:k,events:{click:"enterEditMode"},render:function(){this.empty();var e=s.document.createElement("input");return e.tabIndex=-1,e.type="checkbox",e.checked=this.formatter.fromRaw(this.model.get(this.column.get("name"))),this.el.appendChild(e),this.delegateEvents(),this}});var D=c.SelectCellEditor=C.extend({tagName:"select",events:{change:"save",blur:"close",keydown:"close"},template:i.template('<option value="<%- value %>" <%= selected ? \'selected="selected"\' : "" %>><%- text %></option>'),setOptionValues:function(e){this.optionValues=e},setMultiple:function(e){this.el.multiple=e},_renderOptions:function(e,t){for(var i="",n=0;n<e.length;n++){var r=e[n];i+=this.template({text:r[0],value:r[1],selected:t.indexOf(r[1])>-1})}return i},render:function(){this.empty();var e=i.result(this,"optionValues"),t=this.formatter.fromRaw(this.model.get(this.column.get("name")));if(!i.isArray(e))throw TypeError("optionValues must be an array");for(var n=null,r=null,n=null,o=null,l=[],a=0;a<e.length;a++){var n=e[a];if(i.isArray(n))r=n[0],n=n[1],l.push(this.template({text:r,value:n,selected:t.indexOf(n)>-1}));else{if(!i.isObject(n))throw TypeError("optionValues elements must be a name-value pair or an object hash of { name: 'optgroup label', value: [option name-value pairs] }");o=n.name;var h=s.document.createElement("optgroup");h.label=o,h.innerHTML=this._renderOptions(n.values,t),l.push(h.outerHTML)}}return this.el.innerHTML=l.join(""),this.delegateEvents(),this},save:function(e){var t,i=this.model,n=this.column;if(this.el.multiple){if(this.el.multiple){t=[];for(var r=this.el.querySelectorAll("option"),o=0,s=r.length;s>o;o++){var l=r[o];l.selected&&t.push(l.value)}t.length===0&&(t=null)}}else t=this.el.value;i.set(n.get("name"),this.formatter.toRaw(t)),i.trigger("backgrid:edited",i,n,new d(e))},close:function(e){var t=this.model,i=this.column,n=new d(e);n.cancel()?(e.stopPropagation(),t.trigger("backgrid:edited",t,i,new d(e))):(n.save()||n.moveLeft()||n.moveRight()||n.moveUp()||n.moveDown()||e.type=="blur")&&(e.preventDefault(),e.stopPropagation(),e.type=="blur"&&this.el.querySelectorAll("option").length===1&&t.set(i.get("name"),this.formatter.toRaw(this.el.value)),t.trigger("backgrid:edited",t,i,new d(e)))}});c.SelectCell=x.extend({className:"select-cell",editor:D,multiple:!1,formatter:new E,optionValues:void 0,delimiter:", ",initialize:function(){x.prototype.initialize.apply(this,arguments),c.requireOptions(this,["optionValues"]),this.listenTo(this.model,"backgrid:edit",function(e,t,i,n){t.get("name")==this.column.get("name")&&(n.setOptionValues(this.optionValues),n.setMultiple(this.multiple))})},render:function(){this.empty();var e=this.optionValues,t=this.formatter.fromRaw(this.model.get(this.column.get("name"))),n=[];try{if(!i.isArray(e)||i.isEmpty(e))throw new TypeError;for(var r=0;r<t.length;r++)for(var o=t[r],l=0;l<e.length;l++){var a=e[l];if(i.isArray(a)){var h=a[0],a=a[1];a==o&&n.push(h)}else{if(!i.isObject(a))throw new TypeError;for(var c=a.values,d=0;d<c.length;d++){var u=c[d];u[1]==o&&n.push(u[0])}}}this.el.appendChild(s.document.createTextNode(n.join(this.delimiter)))}catch(m){if(m instanceof TypeError)throw TypeError("'optionValues' must be of type {Array.<Array>|Array.<{name: string, values: Array.<Array>}>}");throw m}return this.delegateEvents(),this}});var S=c.Column=n.Model.extend({defaults:{name:void 0,label:void 0,sortable:!0,editable:!0,renderable:!0,formatter:void 0,cell:void 0,headerCell:void 0},initialize:function(e){c.requireOptions(e,["cell","name"]),this.has("label")||this.set({label:this.get("name")},{silent:!0});var t=c.resolveNameToClass(this.get("headerCell"),"HeaderCell"),i=c.resolveNameToClass(this.get("cell"),"Cell");this.set({cell:i,headerCell:t},{silent:!0})}}),M=c.Columns=n.Collection.extend({model:S}),_=c.Row=c.View.extend({tagName:"tr",requiredOptions:["columns","model"],initialize:function(e){c.requireOptions(e,this.requiredOptions);var t=this.columns=e.columns;t instanceof n.Collection||(t=this.columns=new M(t));for(var i=this.cells=[],r=0;r<t.length;r++)i.push(this.makeCell(t.at(r),e));this.listenTo(t,"change:renderable",function(e,t){for(var n=0;n<i.length;n++){var r=i[n];r.column.get("name")==e.get("name")&&(t?r.show():r.hide())}}),this.listenTo(t,"add",function(t,n){var r=n.indexOf(t),o=this.makeCell(t,e);i.splice(r,0,o),o.column.get("renderable")||o.hide();var s=this.el,l=s.childNodes;0===r?s.insertBefore(o.render().el,s.firstChild):r===n.length-1?s.appendChild(o.render().el):s.insertBefore(o.render().el,l[r])}),this.listenTo(t,"remove",function(e,t,n){i[n.index].remove(),i.splice(n.index,1)})},makeCell:function(e){return new(e.get("cell"))({column:e,model:this.model})},render:function(){this.empty();for(var e=document.createDocumentFragment(),t=0;t<this.cells.length;t++){var i=this.cells[t];e.appendChild(i.render().el),i.column.get("renderable")||i.hide()}return this.el.appendChild(e),this.delegateEvents(),this},remove:function(){for(var e=0;e<this.cells.length;e++){var t=this.cells[e];t.remove.apply(t,arguments)}return c.View.prototype.remove.apply(this,arguments)}}),O=c.EmptyRow=c.View.extend({tagName:"tr",emptyText:null,initialize:function(e){c.requireOptions(e,["emptyText","columns"]),this.emptyText=e.emptyText,this.columns=e.columns},render:function(){this.empty();var e=document.createElement("td");return e.setAttribute("colspan",this.columns.length),e.textContent=this.emptyText,this.el.setAttribute("class","empty"),this.el.appendChild(e),this}}),U=c.HeaderCell=c.View.extend({tagName:"th",events:{"click a":"onClick"},_direction:null,initialize:function(e){c.requireOptions(e,["column","collection"]),this.column=e.column,this.column instanceof S||(this.column=new S(this.column)),this.listenTo(this.collection,"backgrid:sort",this._resetCellDirection)},direction:function(e){return arguments.length&&(this._direction&&this.el.classList.remove(this._direction),e&&this.el.classList.add(e),this._direction=e),this._direction},_resetCellDirection:function(e,t,i,n){n==this.collection&&(e!==this.column.get("name")?this.direction(null):this.direction(t))},onClick:function(e){e.preventDefault();var t=this.column.get("name");this.column.get("sortable")&&(this.direction()==="ascending"?this.sort(t,"descending",function(e,i){var n=e.get(t),r=i.get(t);return n===r?0:n>r?-1:1}):this.direction()==="descending"?this.sort(t,null):this.sort(t,"ascending",function(e,i){var n=e.get(t),r=i.get(t);return n===r?0:r>n?-1:1}))},sort:function(e,t,i){i=i||this._cidComparator;var r=this.collection;if(n.PageableCollection&&r instanceof n.PageableCollection){var o;o="ascending"===t?-1:"descending"===t?1:null,r.setSorting(o?e:null,o),r.mode=="client"?(r.fullCollection.comparator||(r.fullCollection.comparator=i),r.fullCollection.sort()):r.fetch({reset:!0})}else r.comparator=i,r.sort();this.collection.trigger("backgrid:sort",e,t,i,this.collection)},_cidComparator:function(e,t){var n=e.cid,r=t.cid;if(!i.isUndefined(n)&&!i.isUndefined(r)){if(n=n.slice(1)*1,r=r.slice(1)*1,r>n)return-1;if(n>r)return 1}return 0},render:function(){this.empty();var e=s.document,t=e.createElement("a");t.appendChild(e.createTextNode(this.column.get("label")));var i=e.createElement("b");return i.className="sort-caret",t.appendChild(i),this.el.appendChild(t),this.delegateEvents(),this}});c.HeaderRow=c.Row.extend({requiredOptions:["columns","collection"],initialize:function(){c.Row.prototype.initialize.apply(this,arguments)},makeCell:function(e,t){var i=e.get("headerCell")||t.headerCell||U;return i=new i({column:e,collection:this.collection})}});var L=c.Header=c.View.extend({tagName:"thead",initialize:function(e){c.requireOptions(e,["columns","collection"]),this.columns=e.columns,this.columns instanceof n.Collection||(this.columns=new M(this.columns)),this.row=new c.HeaderRow({columns:this.columns,collection:this.collection})},render:function(){return this.el.appendChild(this.row.render().el),this.delegateEvents(),this},remove:function(){return this.row.remove.apply(this.row,arguments),c.View.prototype.remove.apply(this,arguments)}}),V=c.Body=c.View.extend({tagName:"tbody",initialize:function(e){c.requireOptions(e,["columns","collection"]),this.columns=e.columns,this.columns instanceof n.Collection||(this.columns=new M(this.columns)),this.row=e.row||_,this.rows=this.collection.map(function(e){var t=new this.row({columns:this.columns,model:e});return t},this),this.emptyText=e.emptyText,this._unshiftEmptyRowMayBe();var t=this.collection;this.listenTo(t,"add",this.insertRow),this.listenTo(t,"remove",this.removeRow),this.listenTo(t,"sort",this.refresh),this.listenTo(t,"reset",this.refresh),this.listenTo(t,"backgrid:edited",this.moveToNextCell)},_unshiftEmptyRowMayBe:function(){this.rows.length===0&&this.emptyText!=null&&this.rows.unshift(new O({emptyText:this.emptyText,columns:this.columns}))},insertRow:function(e,t,r){if(this.rows[0]instanceof O&&this.rows.pop().remove(),!(t instanceof n.Collection||r))return this.collection.add(e,r=t),void 0;r=i.extend({render:!0},r||{});var o=new this.row({columns:this.columns,model:e}),s=t.indexOf(e);this.rows.splice(s,0,o);var l=this.el,a=l.childNodes,h=o.render().el;r.render&&(s>=a.length?l.appendChild(h):l.insertBefore(h,a[s]))},removeRow:function(e,t,n){return n?((i.isUndefined(n.render)||n.render)&&this.rows[n.index].remove(),this.rows.splice(n.index,1),this._unshiftEmptyRowMayBe(),void 0):(this.collection.remove(e,n=t),this._unshiftEmptyRowMayBe(),void 0)},refresh:function(){for(var e=0;e<this.rows.length;e++)this.rows[e].remove();return this.rows=this.collection.map(function(e){var t=new this.row({columns:this.columns,model:e});return t},this),this._unshiftEmptyRowMayBe(),this.render(),this.collection.trigger("backgrid:refresh",this),this},render:function(){this.empty();for(var e=document.createDocumentFragment(),t=0;t<this.rows.length;t++){var i=this.rows[t];e.appendChild(i.render().el)}return this.el.appendChild(e),this.delegateEvents(),this},remove:function(){for(var e=0;e<this.rows.length;e++){var t=this.rows[e];t.remove.apply(t,arguments)}return c.View.prototype.remove.apply(this,arguments)},moveToNextCell:function(e,t,i){var n=this.collection.indexOf(e),r=this.columns.indexOf(t);if(i.moveUp()||i.moveDown()||i.moveLeft()||i.moveRight()||i.save()){var o=this.columns.length,s=o*this.collection.length;if(i.moveUp()||i.moveDown()){var l=this.rows[n+(i.moveUp()?-1:1)];l&&l.cells[r].enterEditMode()}else if(i.moveLeft()||i.moveRight())for(var a=i.moveRight(),h=n*o+r+(a?1:-1);h>=0&&s>h;a?h++:h--){var c=~~(h/o),d=h-c*o,u=this.rows[c].cells[d];if(u.column.get("renderable")&&u.column.get("editable")){u.enterEditMode();break}}}this.rows[n].cells[r].exitEditMode()}});c.Footer=c.View.extend({tagName:"tfoot",initialize:function(e){c.requireOptions(e,["columns","collection"]),this.columns=e.columns,this.columns instanceof n.Collection||(this.columns=new c.Columns(this.columns))}}),c.Grid=c.View.extend({tagName:"table",className:"backgrid",header:L,body:V,footer:null,initialize:function(e){c.requireOptions(e,["columns","collection"]),e.columns instanceof n.Collection||(e.columns=new M(e.columns)),this.columns=e.columns;var t=i.omit(e,["el","id","attributes","className","tagName","events"]);this.header=e.header||this.header,this.header=new this.header(t),this.body=e.body||this.body,this.body=new this.body(t),this.footer=e.footer||this.footer,this.footer&&(this.footer=new this.footer(t)),this.listenTo(this.columns,"reset",function(){this.header=new(this.header.remove().constructor)(t),this.body=new(this.body.remove().constructor)(t),this.footer&&(this.footer=new(this.footer.remove().constructor)(t)),this.render()})},insertRow:function(e,t,i){return this.body.insertRow(e,t,i)},removeRow:function(e,t,i){return this.body.removeRow(e,t,i)},insertColumn:function(e,t){return t=t||{render:!0},this.columns.add(e,t),this},removeColumn:function(e,t){return this.columns.remove(e,t),this},render:function(){return this.empty(),this.el.appendChild(this.header.render().el),this.footer&&this.el.appendChild(this.footer.render().el),this.el.appendChild(this.body.render().el),this.delegateEvents(),this.trigger("backgrid:rendered",this),this},remove:function(){return this.header.remove.apply(this.header,arguments),this.body.remove.apply(this.body,arguments),this.footer&&this.footer.remove.apply(this.footer,arguments),c.View.prototype.remove.apply(this,arguments)}})})(this,jQuery,_,Backbone);