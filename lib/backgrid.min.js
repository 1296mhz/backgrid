/*
  backgrid
  http://github.com/wyuenho/backgrid

  Copyright (c) 2012 Jimmy Yuen Ho Wong
  Licensed under the MIT @license.
*/
(function(e){var t=t||function(e){throw new ReferenceError(e+" is required but missing.")},n=e._||t("underscore"),r=e.Backbone||t("backbone");n.string||n.str||(n.string=n.str=t("underscore.string"));var i=e.Backgrid={},o=i.Formatter=function(){};n.extend(o.prototype,{fromRaw:function(e){return e},toRaw:function(e){return e}});var l=i.Cell=r.View.extend({tagName:"td",formatter:new o,viewModeEvents:{click:"enterEditMode"},editModeEvents:{blur:"undoAndExitEditMode",keydown:"saveAndExitEditMode"},initialize:function(e){r.View.prototype.initialize.apply(this,arguments),this.formatter=e&&e.formatter||this.formatter,this.column=e&&e.column},render:function(){return this.$el.empty(),this.$el.text(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this.delegateEvents(this.viewModeEvents),this},enterEditMode:function(e){if(this.column.get("editable")){e.preventDefault(),e.stopPropagation();var t=this.$el;this.delegateEvents(this.editModeEvents),t.attr("contenteditable","true").focus()}},saveAndExitEditMode:function(e){if(e.keyCode===13){e.preventDefault();var t=this.formatter.toRaw(this.$el.text());this.model.set(this.column.get("name"),t)&&(this.$el.removeAttr("contenteditable"),this.delegateEvents(this.viewModeEvents))}else e.keyCode===27&&this.undoAndExitEditMode()},undoAndExitEditMode:function(){this.$el.text(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this.$el.removeAttr("contenteditable"),this.delegateEvents(this.viewModeEvents)}}),a=i.StringCell=l.extend({className:"string-cell",formatter:{fromRaw:function(e){return n.escape(e)},toRaw:function(e){return e}}});i.URICell=a.extend({className:"uri-cell",render:function(e){this.setElement(this.$el.clone(!0,!0)[0]),this.$el.empty();var t=this.formatter.fromRaw(e.get(this.column.get("name")));return this.$el.text(t).children().wrap("<a>",{href:t}),this}});var s=i.NumberCell=l.extend({className:"number-cell",decimals:2,decimalSeparator:".",orderSeparator:",",initialize:function(e){var t=this;l.prototype.initialize.apply(t,arguments),e&&(t.decimals=e.decimals!==void 0?e.decimals:t.decimals,t.decimalSeparator=e.decimalSeparator||t.decimalSeparator,t.orderSeparator=e.orderSeparator!==void 0?e.orderSeparator:t.orderSeparator),t.formatter=e&&e.formatter||{fromRaw:function(e){var r=n.str.numberFormat(e,t.decimals,t.decimalSeparator);return r.replace(",",t.orderSeparator)},toRaw:function(e){return(e.replace(t.orderSeparator,"").replace(t.decimalSeparator,".")*1||0).toFixed(~~t.decimals)}}}});i.IntegerCell=s.extend({className:"integer-cell",decimals:0}),i.DatetimeCell=l.extend({className:"datetime-cell",formatter:{fromRaw:function(e){return new Date(e).toISOString()},toRaw:function(){return new Date(rawData).toISOString()}}});var c=i.Column=r.Model.extend({defaults:{name:null,label:null,sortable:!0,editable:!0,renderable:!0,formatter:null,cell:null},initialize:function(e){if(this.has("label")||this.set({label:this.get("name")},{silent:!0}),!e.cell)throw Error("Column.cell is required");if(!e.name)throw Error("Column.name is required");typeof e.cell=="string"?this.set({cell:i[n.str.capitalize(this.get("cell"))+"Cell"]},{silent:!0}):this.set({cell:e.cell},{silent:!0})}}),d=i.Columns=r.Collection.extend({model:c}),u=i.Row=r.View.extend({tagName:"tr",initialize:function(e){var t=this;t.parent=e.parent,t.columns=e.columns,t.columns instanceof r.Collection||(t.columns=new d(t.columns))},render:function(){var e=this;return e.$el.empty(),e.columns.each(function(t){if(t.get("renderable")){var n=t.get("cell");n=new n({column:t,model:e.model}),e.$el.append(n.render(e.model).$el)}}),e}}),m=i.HeaderCell=r.View.extend({tagName:"th",events:{"click a":"triggerSort"},direction:null,initialize:function(e){this.parent=e.parent,this.column=e.column,!this.column instanceof c&&(this.column=new c(this.column))},toggle:function(e,t){var n=this.$el.find("a");n.removeClass("ascending descending"),e===this.column.get("name")?(t&&n.addClass(t),this.direction=t):this.direction=null},triggerSort:function(e){e.preventDefault();var t=this,n=t.column.get("name");this.direction==="ascending"?t.trigger("sort",function(e,t){var r=e.get(n),i=t.get(n);return r===i?0:r>i?-1:1},n,"descending"):this.direction==="descending"?t.trigger("sort",null,n,null):t.trigger("sort",function(e,t){var r=e.get(n),i=t.get(n);return r===i?0:i>r?-1:1},n,"ascending")},render:function(){this.$el.empty();var e=$("<a>").text(this.column.get("label")).append("<b class='sort-caret'></b>");return this.$el.append(e),this}}),h=i.Header=r.View.extend({tagName:"thead",initialize:function(e){var t=this;t.parent=e.parent,t.columns=e.columns,t.columns instanceof r.Collection||(t.columns=new d(t.columns)),t.cells=t.columns.map(function(e){var n=new m({parent:t,column:e});return n.on("sort",t.dispatchSortEvent,t),n})},dispatchSortEvent:function(e,t,r){this.parent.sort(e),n.each(this.cells,function(e){e.toggle(t,r)})},render:function(){var e=this;return e.$el.empty(),n.each(e.cells,function(t){e.$el.append(t.render().$el)}),e}}),f=i.Body=r.View.extend({tagName:"tbody",initialize:function(e){var t=this;t.parent=e.parent,t.columns=e.columns,t.columns instanceof r.Collection||(t.columns=new d(t.columns)),t.rows=t.collection.map(function(e){var n=new u({parent:t,columns:t.columns,model:e});return n}),t.collection.on("add",t.insertRow,t),t.collection.on("remove",t.removeRow,t),t.collection.on("reset",t.refresh,t),t.collection.comparator||(t.collection.comparator=t._idCidComparator)},sort:function(e){this.collection.comparator=e||this._idCidComparator,this.collection.sort()},_idCidComparator:function(e,t){var n=e.id,r=e.cid,i=t.cid,o=t.rcid;if(n&&i){if(i>n)return-1;if(n>i)return-1}else if(n&&o){if(o>n)return-1;if(n>o)return 1}else if(r&&i){if(i>r)return-1;if(r>i)return 1}else if(r&&o){if(o>r)return-1;if(r>o)return 1}return 0},insertRow:function(e,t,n){if(n){var r=new u({parent:this,columns:this.columns,model:e});this.rows.splice(n.index,0,r),(n.render===void 0||n.render)&&(n.index>=this.$el.children().length?this.$el.children().last().after(r.render().$el):this.$el.children().eq(n.index).before(r.render().$el))}else this.collection.add(e,n=t)},removeRow:function(e,t,n){n?((n.render===void 0||n.render)&&this.rows[n.index].remove(),this.rows.splice(n.index,1)):this.collection.remove(e,n=t)},refresh:function(){var e=this;return e.rows=e.collection.map(function(t){var n=new u({parent:e,columns:e.columns,model:t});return n}),e.render()},render:function(){var e=this;return e.$el.empty(),n.each(e.rows,function(t){e.$el.append(t.render().$el)}),this}});i.Footer=r.View.extend({tagName:"tfoot"}),i.Grid=r.View.extend({tagName:"table",className:"backgrid",initialize:function(e){this.columns=e.columns,this.header=e.header?new e.header({parent:this,columns:this.columns}):new h({parent:this,columns:this.columns}),this.body=new f({parent:this,columns:this.columns,collection:this.collection}),e.footer&&(this.footer=new e.footer({parent:this,columns:this.columns}))},sort:function(e){this.body.sort(e)},render:function(){return this.$el.empty(),this.$el.append(this.header.render().$el),this.footer&&this.$el.append(this.footer.render().$el),this.$el.append(this.body.render().$el),this.trigger("rendered"),this}})})(this)