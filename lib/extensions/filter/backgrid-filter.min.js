/*
  backgrid-filter
  http://github.com/wyuenho/backgrid

  Copyright (c) 2013 Jimmy Yuen Ho Wong and contributors
  Licensed under the MIT @license.
*/
(function(e,t,i,n){"use strict";var s=i.Extension.ServerSideFilter=i.View.extend({tagName:"form",className:"backgrid-filter form-search",template:e.template('<div class="input-prepend input-append"><span class="add-on"><i class="icon-search"></i></span><input type="text" <% if (placeholder) { %> placeholder="<%- placeholder %>" <% } %> name="<%- name %>" /><span class="add-on"><a class="close" href="#">&times;</a></span></div>'),events:{"click .close":"clear",submit:"search"},name:"q",placeholder:null,initialize:function(e){i.requireOptions(e,["collection"]),i.View.prototype.initialize.apply(this,arguments),this.name=e.name||this.name,this.placeholder=e.placeholder||this.placeholder},searchBox:function(){return this.el.querySelector("input[type=text]")},search:function(e){e&&e.preventDefault();var t=this.searchBox(),i={};i[t.name]=t.value,this.collection.fetch({data:i})},clear:function(e){e&&e.preventDefault(),this.searchBox().value=null,this.collection.fetch()},render:function(){return this.empty().el.innerHTML=this.template({name:this.name,placeholder:this.placeholder,value:this.value}),this.delegateEvents(),this}}),a=i.Extension.ClientSideFilter=s.extend({events:{"click .close":function(e){e.preventDefault(),this.clear()},"change input[type=text]":"search","keyup input[type=text]":"search",submit:function(e){e.preventDefault(),this.search()}},fields:null,wait:149,initialize:function(t){s.prototype.initialize.apply(this,arguments),this.fields=t.fields||this.fields,this.wait=t.wait||this.wait,this._debounceMethods(["search","clear"]);var i=this.collection,n=this.shadowCollection=i.clone();n.url=i.url,n.sync=i.sync,n.parse=i.parse,this.listenTo(i,"add",function(e,t,i){n.add(e,i)}),this.listenTo(i,"remove",function(e,t,i){n.remove(e,i)}),this.listenTo(i,"sort reset",function(t,i){i=e.extend({reindex:!0},i||{}),i.reindex&&n.reset(t.models)})},_debounceMethods:function(t){e.isString(t)&&(t=[t]),this.undelegateEvents();for(var i=0,n=t.length;n>i;i++){var s=t[i],a=this[s];this[s]=e.debounce(a,this.wait)}this.delegateEvents()},makeMatcher:function(e){var t=RegExp(e.trim().split(/\W/).join("|"),"i");return function(e){for(var i=this.fields||e.keys(),n=0,s=i.length;s>n;n++)if(t.test(e.get(i[n])+""))return!0;return!1}},search:function(){var t=e.bind(this.makeMatcher(this.searchBox().value),this);this.collection.reset(this.shadowCollection.filter(t),{reindex:!1})},clear:function(){this.searchBox().value=null,this.collection.reset(this.shadowCollection.models,{reindex:!1})}});i.Extension.LunrFilter=a.extend({ref:"id",fields:null,initialize:function(e){a.prototype.initialize.apply(this,arguments),this.ref=e.ref||this.ref;var t=this.collection;this.listenTo(t,"add",this.addToIndex),this.listenTo(t,"remove",this.removeFromIndex),this.listenTo(t,"reset",this.resetIndex),this.listenTo(t,"change",this.updateIndex),this.resetIndex(t)},resetIndex:function(t,i){if(i=e.extend({reindex:!0},i||{}),i.reindex){var s=this;this.index=n(function(){e.each(s.fields,function(e,t){this.field(t,e),this.ref(s.ref)},this)}),t.each(function(e){this.addToIndex(e)},this)}},addToIndex:function(e){var t=this.index,i=e.toJSON();t.documentStore.has(i[this.ref])?t.update(i):t.add(i)},removeFromIndex:function(e){var t=this.index,i=e.toJSON();t.documentStore.has(i[this.ref])&&t.remove(i)},updateIndex:function(t){var i=t.changedAttributes();i&&!e.isEmpty(e.intersection(e.keys(this.fields),e.keys(i)))&&this.index.update(t.toJSON())},search:function(){for(var e=this.index.search(this.searchBox().value),t=[],i=0;e.length>i;i++){var n=e[i];t.push(this.shadowCollection.get(n.ref))}this.collection.reset(t,{reindex:!1})}})})(_,Backbone,Backgrid,lunr);