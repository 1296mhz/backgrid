/*
  backgrid-filter
  http://github.com/wyuenho/backgrid

  Copyright (c) 2013 Jimmy Yuen Ho Wong and contributors
  Licensed under the MIT @license.
*/
!function(e){"use strict";var t=e.Backbone,i=e.Backgrid,n=e.lunr,s=i.Extension.ServerSideFilter=t.View.extend({tagName:"form",className:"backgrid-filter form-search",template:_.template('<div class="input-prepend input-append"><span class="add-on"><i class="icon-search"></i></span><input type="text" <% if (placeholder) { %> placeholder="<%- placeholder %>" <% } %> name="<%- name %>" /><span class="add-on"><a class="close" href="#">&times;</a></span></div>'),events:{"click .close":"clear",submit:"search"},name:"q",placeholder:null,initialize:function(e){i.requireOptions(e,["collection"]),t.View.prototype.initialize.apply(this,arguments),this.name=e.name||this.name,this.placeholder=e.placeholder||this.placeholder;var n=this.collection,s=this;t.PageableCollection&&n instanceof t.PageableCollection&&"server"==n.mode&&(n.queryParams[this.name]=function(){return s.searchBox().val()||null})},searchBox:function(){return this.$el.find("input[type=text]")},search:function(e){e&&e.preventDefault();var i={},n=this.collection;if(t.PageableCollection&&n instanceof t.PageableCollection&&"server"==n.mode)n.state.currentPage=1;else{var s=this.searchBox().val();s&&(i[this.name]=s)}n.fetch({data:i,reset:!0})},clear:function(e){e&&e.preventDefault(),this.searchBox().val(null),this.collection.fetch({reset:!0})},render:function(){return this.$el.empty().append(this.template({name:this.name,placeholder:this.placeholder,value:this.value})),this.delegateEvents(),this}}),l=i.Extension.ClientSideFilter=s.extend({events:{"click .close":function(e){e.preventDefault(),this.clear()},"keydown input[type=text]":"search",submit:function(e){e.preventDefault(),this.search()}},fields:null,wait:149,initialize:function(e){s.prototype.initialize.apply(this,arguments),this.fields=e.fields||this.fields,this.wait=e.wait||this.wait,this._debounceMethods(["search","clear"]);var t=this.collection=this.collection.fullCollection||this.collection,i=this.shadowCollection=t.clone();this.listenTo(t,"add",function(e,t,n){i.add(e,n)}),this.listenTo(t,"remove",function(e,t,n){i.remove(e,n)}),this.listenTo(t,"sort",function(e){this.searchBox().val()||i.reset(e.models)}),this.listenTo(t,"reset",function(e,n){n=_.extend({reindex:!0},n||{}),n.reindex&&e===t&&null==n.from&&null==n.to&&i.reset(e.models)})},_debounceMethods:function(e){_.isString(e)&&(e=[e]),this.undelegateEvents();for(var t=0,i=e.length;i>t;t++){var n=e[t],s=this[n];this[n]=_.debounce(s,this.wait)}this.delegateEvents()},makeMatcher:function(e){var t=new RegExp(e.trim().split(/\W/).join("|"),"i");return function(e){for(var i=this.fields||e.keys(),n=0,s=i.length;s>n;n++)if(t.test(e.get(i[n])+""))return!0;return!1}},search:function(){var e=_.bind(this.makeMatcher(this.searchBox().val()),this),t=this.collection;t.pageableCollection&&t.pageableCollection.getFirstPage({silent:!0}),this.collection.reset(this.shadowCollection.filter(e),{reindex:!1})},clear:function(){this.searchBox().val(null),this.collection.reset(this.shadowCollection.models,{reindex:!1})}});i.Extension.LunrFilter=l.extend({ref:"id",fields:null,initialize:function(e){l.prototype.initialize.apply(this,arguments),this.ref=e.ref||this.ref;var t=this.collection=this.collection.fullCollection||this.collection;this.listenTo(t,"add",this.addToIndex),this.listenTo(t,"remove",this.removeFromIndex),this.listenTo(t,"reset",this.resetIndex),this.listenTo(t,"change",this.updateIndex),this.resetIndex(t)},resetIndex:function(e,t){if(t=_.extend({reindex:!0},t||{}),t.reindex){var i=this;this.index=n(function(){_.each(i.fields,function(e,t){this.field(t,e),this.ref(i.ref)},this)}),e.each(function(e){this.addToIndex(e)},this)}},addToIndex:function(e){var t=this.index,i=e.toJSON();t.documentStore.has(i[this.ref])?t.update(i):t.add(i)},removeFromIndex:function(e){var t=this.index,i=e.toJSON();t.documentStore.has(i[this.ref])&&t.remove(i)},updateIndex:function(e){var t=e.changedAttributes();t&&!_.isEmpty(_.intersection(_.keys(this.fields),_.keys(t)))&&this.index.update(e.toJSON())},search:function(){for(var e=this.index.search(this.searchBox().val()),t=[],i=0;i<e.length;i++){var n=e[i];t.push(this.shadowCollection.get(n.ref))}var s=this.collection;s.pageableCollection&&s.pageableCollection.getFirstPage({silent:!0}),s.reset(t,{reindex:!1})}})}(this);